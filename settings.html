<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Settings - Stashio</title>
    
    <meta name="theme-color" content="#4F46E5">

        <script>
        // শুধুমাত্র localStorage ব্যবহার করা হচ্ছে
        const loggedInUser = localStorage.getItem('userPhone') || localStorage.getItem('tempUserPhone');
        const activeShopId = localStorage.getItem('activeShopId');
        
        if (!loggedInUser) {
            window.location.replace("index.html");
        } else if (!activeShopId) {
            window.location.replace("dashboard.html");
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4F46E5; --secondary: #ec4899; --bg-color: #f3f4f6;
            --white: #ffffff; --text-dark: #1f2937; --text-light: #6b7280;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --blue: #3b82f6;
            --purple: #8b5cf6;
            --border-radius: 20px; --shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { background-color: var(--bg-color); color: var(--text-dark); padding-bottom: 90px; overflow-x: hidden; position: relative; }
        a { text-decoration: none; color: inherit; display: block; }

        /* Dynamic Header Area (Standardized) */
        .app-header {
            position: relative; padding: 30px 20px 50px 20px; color: white; 
            border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; 
            margin-bottom: -30px; overflow: hidden; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
            z-index: 10;
        }
        .header-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); z-index: 1; }
        #dynamicThemeContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; overflow: hidden; }
        .header-content { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; }
        .header-content p { font-size: 12px; font-weight: 500; opacity: 0.9; margin-top: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); background: rgba(255, 255, 255, 0.15); padding: 3px 10px; border-radius: 10px; display: inline-block; }

        

        /* Settings Card Structure */
        .section-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: var(--border-radius); padding: 25px 20px; box-shadow: var(--shadow); margin: 0 15px 20px 15px; position: relative; z-index: 20; border: 1px solid #f8fafc; }
        .section-title { font-size: 14px; font-weight: 800; color: var(--text-dark); margin-bottom: 20px; display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 4px; height: 16px; background: var(--primary); border-radius: 5px; margin-right: 8px; }

        /* Image Styling */
        .profile-wrapper { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        .profile-img-container { position: relative; cursor: pointer; }
        .profile-img { width: 100px; height: 100px; border-radius: 30%; object-fit: cover; border: 4px solid white; background: #f1f5f9; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: 0.3s; }
        .profile-img-container:active .profile-img { transform: scale(0.95); }
        .camera-icon { position: absolute; bottom: -5px; right: -5px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 3px solid white; font-size: 14px; pointer-events: none; box-shadow: 0 4px 10px rgba(236, 72, 153, 0.3); }

        /* Form Inputs */
        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 5px; display: block; text-transform: uppercase; }
        .input-field { width: 100%; padding: 14px 15px; border: 2px solid #f1f5f9; border-radius: 14px; font-size: 14px; outline: none; transition: 0.3s; background: #f8fafc; color: var(--text-dark); font-family: inherit; font-weight: 500; }
        .input-field:focus { border-color: var(--primary); background: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.08); }
        .input-field:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; border-color: transparent; }
        
        .save-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 14px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(236, 72, 153, 0.25); transition: 0.2s; margin-top: 5px; }
        .save-btn:active { transform: scale(0.98); }

        .loader { display: none; text-align: center; padding: 10px; font-size: 12px; font-weight: 700; color: var(--primary); margin-top: 5px; }

        /* Menu Items */
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-item { display: flex; align-items: center; padding: 15px; border-radius: 14px; margin-bottom: 12px; background: #f8fafc; cursor: pointer; transition: 0.2s; border: 1px solid #f1f5f9; }
        .menu-item:last-child { margin-bottom: 0; }
        .menu-item:active { transform: scale(0.97); background: #f1f5f9; }
        
        /* Security Guard Class - Hidden by default */
        .perm-check { display: none; }

        .menu-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .menu-text { flex-grow: 1; font-size: 14px; font-weight: 600; color: var(--text-dark); }
        .menu-arrow { color: #cbd5e1; font-size: 14px; }

        /* Specific Menu Colors */
        .item-switch .menu-icon { color: var(--blue); background: #dbeafe; }
        .item-card .menu-icon { color: var(--primary); background: #e0e7ff; }
        .item-bin .menu-icon { color: var(--warning); background: #fef3c7; }
        .item-access .menu-icon { color: var(--purple); background: #f3e8ff; }
        
        .item-logout { background: #fef2f2; border-color: #fee2e2; }
        .item-logout .menu-icon { color: var(--danger); background: white; }
        .item-logout .menu-text { color: var(--danger); }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: var(--white); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 25px rgba(0,0,0,0.08); border-top-left-radius: 30px; border-top-right-radius: 30px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9ca3af; flex: 1; height: 100%; position: relative; transition: 0.3s; cursor: pointer; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item span { font-size: 11px; font-weight: 700; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-4px); }
        .nav-item.active::after { content: ''; position: absolute; top: 12px; right: 35%; width: 6px; height: 6px; background: var(--secondary); border-radius: 50%; }

        body.has-theme .bottom-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
    </style>
</head>
<body>

    <div id="header-container" class="app-header"></div>

    <div class="section-card">
        <div class="section-title">My Profile</div>
        
        <div class="input-group">
            <label class="input-label">My Mobile Number</label>
            <input type="text" id="userPhone" class="input-field" disabled>
        </div>
        <div class="input-group">
            <label class="input-label">My Role</label>
            <input type="text" id="userRole" class="input-field" disabled>
        </div>
    </div>

    <div class="section-card perm-check" data-page="settings.html" id="shopSettingsSection">
        <div class="section-title">Shop Details</div>
        
        <div class="profile-wrapper">
            <div class="profile-img-container" onclick="document.getElementById('shopImageInput').click()">
                <img id="shopImgPreview" src="https://via.placeholder.com/150?text=Logo" class="profile-img">
                <div class="camera-icon"><i class="fas fa-camera"></i></div>
                <input type="file" id="shopImageInput" hidden accept="image/*">
            </div>
        </div>

        <div class="input-group">
            <label class="input-label">Shop Name</label>
            <input type="text" id="shopName" class="input-field" placeholder="Enter Shop Name">
        </div>

        <div class="input-group">
            <label class="input-label">Shop Address</label>
            <input type="text" id="shopAddress" class="input-field" placeholder="Full Address">
        </div>

        <p id="updateStatus" class="loader"><i class="fas fa-spinner fa-spin"></i> Saving changes...</p>
        <button class="save-btn" onclick="updateProfile()">Save Changes</button>
    </div>

    <div class="section-card" style="margin-bottom: 40px; padding: 15px;">
        <ul class="menu-list">
            
            <li class="menu-item item-switch" onclick="switchShop()">
                <div class="menu-icon"><i class="fas fa-exchange-alt"></i></div>
                <span class="menu-text">Switch Shop</span>
                <i class="fas fa-chevron-right menu-arrow"></i>
            </li>

            <li class="menu-item item-card perm-check" data-page="business-card.html" onclick="window.location.href='business-card.html'">
                <div class="menu-icon"><i class="fas fa-id-card"></i></div>
                <span class="menu-text">Digital Business Card</span>
                <i class="fas fa-chevron-right menu-arrow"></i>
            </li>

            <li class="menu-item item-access perm-check" data-page="app_access.html" onclick="window.location.href='app_access.html'">
                <div class="menu-icon"><i class="fas fa-shield-halved"></i></div>
                <span class="menu-text">Team & Access Control</span>
                <i class="fas fa-chevron-right menu-arrow"></i>
            </li>

            <li class="menu-item item-bin perm-check" data-page="recycle_bin.html" onclick="window.location.href='recycle_bin.html'">
                <div class="menu-icon"><i class="fas fa-trash-restore"></i></div>
                <span class="menu-text">Recycle Bin</span>
                <i class="fas fa-chevron-right menu-arrow"></i>
            </li>

            <li class="menu-item item-logout" onclick="logout()">
                <div class="menu-icon"><i class="fas fa-sign-out-alt"></i></div>
                <span class="menu-text">Logout</span>
                <i class="fas fa-chevron-right menu-arrow text-danger"></i>
            </li>
        </ul>
    </div>

    <div id="bottom-nav-container" class="bottom-nav"></div>

    <script type="module">
        // মডুলার ফায়ারবেস কনফিগ ফাইল ইমপোর্ট করা
        import { rtdb, dbFirestore, doc, getDoc, updateDoc, ref as rtdbRef, onValue as rtdbOnValue } from './firebase_config.js';

        const IMGBB_API_KEY = "0987dd0d8cae9aa6bbe0b075b4464432";

        const activeShopId = localStorage.getItem('activeShopId');
        const userPhone = localStorage.getItem('userPhone') || localStorage.getItem('tempUserPhone');

        // Header & Footer Load Function
        async function loadComponents() {
            try {
                // Header Load
                const headerRes = await fetch('header.html');
                if (headerRes.ok) {
                    document.getElementById('header-container').innerHTML = await headerRes.text();
                    
                    // সেটিংস পেজের জন্য হেডার টেক্সট পরিবর্তন
                    document.getElementById('shopTitle').innerHTML = `<i class="fas fa-user-cog" style="color: #fef08a;"></i> Account Settings`;
                    const subText = document.querySelector('.header-content p');
                    if(subText) subText.innerText = "Manage your profile & shop";
                    
                    // Header Theme Sync
                    rtdbOnValue(rtdbRef(rtdb, `global_settings/header_theme`), (snap) => {
                        const themeCode = snap.exists() ? snap.val().code : null;
                        if (themeCode && themeCode.trim() !== "") {
                            document.getElementById('dynamicThemeContainer').innerHTML = themeCode;
                            document.body.classList.add('has-theme');
                        } else {
                            document.getElementById('dynamicThemeContainer').innerHTML = "";
                            document.body.classList.remove('has-theme');
                        }
                    });
                }

                // Bottom Nav Load
                const navRes = await fetch('bottom_nav.html');
                if (navRes.ok) {
                    document.getElementById('bottom-nav-container').innerHTML = await navRes.text();
                    // সেটিংস পেজের মেন্যুটি এক্টিভ করা
                    document.getElementById('nav-settings').classList.add('active');
                }
            } catch (error) {
                console.error("Error loading components:", error);
            }
        }

        window.onload = () => {
            loadComponents(); // 컴পোনেন্ট লোড কল করা
            document.getElementById('userPhone').value = userPhone;

            // --- PERMISSION LOGIC (Hide/Show Menu Items) ---
            const myRole = localStorage.getItem('myRole') || 'staff';
            const myPerms = JSON.parse(localStorage.getItem('myPermissions') || '{}');
            
            document.querySelectorAll('.perm-check').forEach(el => {
                const targetPage = el.getAttribute('data-page');
                if(myRole === 'owner' || myPerms[targetPage] === true) {
                    if(el.classList.contains('section-card')) {
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'flex'; 
                    }
                } else {
                    el.style.display = 'none';
                }
            });

            // 1. OFFLINE LOAD FIRST
            const cachedShop = localStorage.getItem(`shop_details_${activeShopId}`);
            if(cachedShop) {
                const data = JSON.parse(cachedShop);
                document.getElementById('shopName').value = data.name || '';
                document.getElementById('shopAddress').value = data.address || '';
                if(data.image) document.getElementById('shopImgPreview').src = data.image;
                
                const role = (data.roles && data.roles[userPhone]) ? data.roles[userPhone] : "Employee";
                document.getElementById('userRole').value = role.charAt(0).toUpperCase() + role.slice(1);
            }

            // 2. ONLINE SYNC
            fetchShopDetails();
        };

        async function fetchShopDetails() {
            try {
                const shopRef = doc(dbFirestore, "shops", activeShopId);
                const docSnap = await getDoc(shopRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    localStorage.setItem(`shop_details_${activeShopId}`, JSON.stringify(data));
                    
                    document.getElementById('shopName').value = data.name || '';
                    document.getElementById('shopAddress').value = data.address || '';
                    if(data.image) document.getElementById('shopImgPreview').src = data.image;

                    const role = (data.roles && data.roles[userPhone]) ? data.roles[userPhone] : "Employee";
                    document.getElementById('userRole').value = role.charAt(0).toUpperCase() + role.slice(1);
                }
            } catch(e) {
                console.log("Error fetching data:", e);
            }
        }

        window.updateProfile = async () => {
            const name = document.getElementById('shopName').value;
            const address = document.getElementById('shopAddress').value;
            const fileInput = document.getElementById('shopImageInput');
            const status = document.getElementById('updateStatus');
            const btn = document.querySelector('.save-btn');
            
            status.style.display = "block";
            status.style.color = "var(--primary)";
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading logic...';
            btn.disabled = true;
            
            try {
                let updateData = { name: name, address: address };
                
                // Image Upload
                if (fileInput.files[0]) {
                    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading Image...';
                    const formData = new FormData();
                    formData.append("image", fileInput.files[0]);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                    const data = await res.json();
                    if(data.data && data.data.url) updateData.image = data.data.url;
                }

                const shopRef = doc(dbFirestore, "shops", activeShopId);
                await updateDoc(shopRef, updateData);
                
                localStorage.setItem('activeShopName', name);
                let cached = JSON.parse(localStorage.getItem(`shop_details_${activeShopId}`) || "{}");
                cached = { ...cached, ...updateData };
                localStorage.setItem(`shop_details_${activeShopId}`, JSON.stringify(cached));

                status.style.color = "var(--success)";
                status.innerHTML = '<i class="fas fa-check-circle"></i> Update Successful!';
                if(updateData.image) document.getElementById('shopImgPreview').src = updateData.image;
                
                setTimeout(() => { status.style.display = "none"; btn.disabled = false; }, 2000);

            } catch (error) {
                status.style.color = "var(--danger)";
                status.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + error.message;
                btn.disabled = false;
            }
        };

        window.switchShop = () => {
            localStorage.removeItem('activeShopId');
            localStorage.removeItem('activeShopName');
            sessionStorage.setItem('tempUserPhone', userPhone);
            window.location.href = "dashboard.html";
        };

        window.logout = () => {
            if(confirm("Are you sure you want to log out safely?")) {
                localStorage.clear(); 
                sessionStorage.clear();
                window.location.replace("index.html");
            }
        };

        document.getElementById('shopImageInput').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) { 
                    document.getElementById('shopImgPreview').src = event.target.result; 
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    </script>
</body>
</html>
