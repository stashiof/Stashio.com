<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Team & Access - Stashio</title>
    
    <meta name="theme-color" content="#4F46E5">

    <script>
        const loggedInUser = localStorage.getItem('tempUserPhone') || localStorage.getItem('userPhone');
        const activeShopId = localStorage.getItem('activeShopId');
        if (!loggedInUser) window.location.replace("index.html");
        else if (!activeShopId) window.location.replace("dashboard.html");
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4F46E5; --secondary: #ec4899; --bg-color: #f2f2f7;
            --white: rgba(255, 255, 255, 0.85); --text-dark: #1c1c1e; --text-light: #8e8e93;
            --danger: #ff3b30; --success: #34c759; --warning: #ff9500; --blue: #007aff;
            --purple: #af52de;
            --border-radius: 24px; --shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-dark); padding-bottom: 30px; overflow-x: hidden; position: relative; }

        /* Dynamic Header Area */
        .app-header {
            position: relative; padding: 30px 20px 50px 20px; color: white; 
            border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; 
            margin-bottom: -20px; z-index: 10; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
            overflow: hidden;
        }
        .header-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); z-index: 1; }
        #dynamicThemeContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; overflow: hidden; }
        .header-content { position: relative; z-index: 10; display: flex; align-items: center; gap: 15px; }
        .header-content a { color: white; font-size: 20px; text-decoration: none; }
        .header-content h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        

        /* User List */
        .user-list { padding: 0 15px; display: grid; grid-template-columns: 1fr; gap: 15px; position: relative; z-index: 20; }
        @media (min-width: 768px) { .user-list { grid-template-columns: repeat(2, 1fr); } }

        .user-card { 
            background: var(--white); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius); padding: 15px; box-shadow: var(--shadow); 
            display: flex; align-items: center; gap: 15px; border: var(--glass-border); 
            border-left: 5px solid transparent; transition: 0.2s; cursor: pointer;
        }
        .user-card:active { transform: scale(0.97); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .border-owner { border-left-color: var(--success); } .badge-owner { background: #dcfce3; color: var(--success); }
        .border-manager { border-left-color: var(--blue); } .badge-manager { background: #dbeafe; color: var(--blue); }
        .border-staff { border-left-color: var(--warning); } .badge-staff { background: #fef3c7; color: var(--warning); }
        .border-custom { border-left-color: var(--purple); } .badge-custom { background: #f3e8ff; color: var(--purple); }

        .user-img { width: 55px; height: 55px; border-radius: 16px; object-fit: cover; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); background: #f1f5f9; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: 800; font-size: 15px; color: var(--text-dark); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .role-badge { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 4px; text-transform: uppercase; }
        .details-row { font-size: 11px; color: var(--text-light); margin-top: 6px; display: flex; gap: 10px; font-weight: 600; }

        /* Floating Action Button */
        .fab { position: fixed; bottom: 30px; right: 20px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); cursor: pointer; z-index: 95; transition: 0.3s; }
        .fab:active { transform: scale(0.9); }

        /* Modal Settings */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; align-items: flex-end; justify-content: center; }
        .modal-content { background: var(--bg-color); width: 100%; max-width: 500px; max-height: 90vh; border-top-left-radius: 30px; border-top-right-radius: 30px; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.2); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (min-width: 768px) { .modal-overlay { align-items: center; } .modal-content { border-radius: 25px; height: auto; } }

        .modal-header { padding: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .btn-close { background: #f2f2f7; border: none; width: 32px; height: 32px; border-radius: 50%; color: var(--text-dark); font-size: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }

        .upload-area { text-align: center; margin-bottom: 20px; }
        .preview-img { width: 90px; height: 90px; border-radius: 28px; object-fit: cover; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.08); background: #f1f5f9; cursor: pointer; }
        
        /* Inputs & Checkboxes */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 5px; text-transform: uppercase; }
        .input-field { width: 100%; padding: 14px 15px; border: 1px solid rgba(0,0,0,0.05); border-radius: 16px; font-size: 13px; font-family: inherit; font-weight: 500; outline: none; background: white; transition: 0.3s; color: var(--text-dark); }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .input-field:disabled { background: #e5e5ea; color: #8e8e93; }

        .perm-title { font-size: 13px; font-weight: 800; color: var(--text-dark); margin: 25px 0 10px 0; display: flex; align-items: center; gap: 6px; }
        .perm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .perm-check { display: flex; align-items: center; gap: 10px; background: white; padding: 12px; border-radius: 14px; border: 1px solid rgba(0,0,0,0.05); font-size: 12px; font-weight: 600; cursor: pointer; user-select: none; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .perm-check.active { background: #e0e7ff; border-color: var(--primary); color: var(--primary); }
        .perm-check.disabled { opacity: 0.5; pointer-events: none; }
        .perm-check input { width: 18px; height: 18px; margin: 0; pointer-events: none; }

        .btn-save { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 16px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3); margin-top: 25px; transition: 0.2s; }
        .btn-save:active { transform: scale(0.98); }
        .btn-save:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        .btn-delete { background: white; color: var(--danger); border: 2px solid #fee2e2; box-shadow: none; margin-top: 10px; }

        #loading { text-align: center; padding: 40px; color: var(--text-dark); font-weight: 600; font-size: 14px; position: relative; z-index: 20; }
        body.has-theme #loading { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="header-container" class="app-header">
        <div class="header-bg"></div>
        <div id="dynamicThemeContainer"></div>
        <div class="header-content">
            <a href="settings.html"><i class="fas fa-arrow-left"></i></a>
            <h1 id="shopTitle">Team & Access</h1>
        </div>
    </div>

    <div id="loading"><i class="fas fa-spinner fa-spin" style="font-size: 28px; margin-bottom: 10px;"></i><br>Checking Access...</div>
    
    <div class="user-list" id="userList" style="display: none;"></div>

    <div class="fab" onclick="openModal('add')" id="fabAdd" style="display: none;">
        <i class="fas fa-plus"></i>
    </div>

    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; font-size:16px; font-weight:800;" id="modalTitle">Manage Member</h3>
                <button onclick="closeModal()" class="btn-close"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-body">
                <div class="upload-area">
                    <label for="imgInput">
                        <img id="imgPreview" src="https://via.placeholder.com/150" class="preview-img">
                        <div style="font-size:11px; font-weight:700; color:var(--primary); margin-top:8px;" id="imgChangeText"><i class="fas fa-camera"></i> Change Photo</div>
                    </label>
                    <input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="previewImage(this)">
                </div>

                <div class="input-group">
                    <label>Mobile Number / Email</label>
                    <input type="text" id="userPhone" class="input-field" placeholder="User's login ID (Phone/Email)">
                </div>
                
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="userName" class="input-field" placeholder="Enter Full Name">
                </div>

                <div style="display:flex; gap:10px;">
                    <div class="input-group" style="flex:1;">
                        <label>Join Date</label>
                        <input type="date" id="joinDate" class="input-field">
                    </div>
                    <div class="input-group" style="flex:1;">
                        <label>Role</label>
                        <select id="userRole" class="input-field" onchange="handleRoleChange()">
                            <option value="staff">Staff</option>
                            <option value="manager">Manager</option>
                            <option value="owner">Owner (Full Access)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>

                <div class="input-group" id="customTitleBox" style="display:none;">
                    <label>Custom Title Name</label>
                    <input type="text" id="customTitle" class="input-field" placeholder="e.g. Senior Accountant">
                </div>

                <div class="perm-title"><i class="fas fa-shield-alt text-primary"></i> Page Access Permissions</div>
                <div class="perm-grid" id="permList"></div>

                <button class="btn-save" id="saveBtn" onclick="saveUser()">Save Member</button>
                <button class="btn-save btn-delete" id="deleteBtn" onclick="deleteUser()" style="display:none;"><i class="fas fa-user-slash"></i> Remove Access</button>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIGURATION (V8 STANDARD) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBeAEsuacInlrQx05C1uDtqL0DeFzRojMY",
        authDomain: "stashio-6b332.firebaseapp.com",
        projectId: "stashio-6b332",
        databaseURL: "https://stashio-6b332-default-rtdb.firebaseio.com",
        storageBucket: "stashio-6b332.firebasestorage.app"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const dbFirestore = firebase.firestore();
    const rtdb = firebase.database();

    const IMGBB_KEY = "0987dd0d8cae9aa6bbe0b075b4464432";
    const shopId = localStorage.getItem('activeShopId');
    const myPhone = localStorage.getItem('userPhone') || localStorage.getItem('tempUserPhone');
    let currentShopData = {};

    const ALL_PAGES = [
        { file: "sell.html", name: "Sale Counter", icon: "fa-shopping-bag" },
        { file: "purchase.html", name: "Purchase Entry", icon: "fa-cart-shopping" },
        { file: "product_list.html", name: "Product List", icon: "fa-box-open" },
        { file: "stock_book.html", name: "Stock History", icon: "fa-boxes-stacked" },
        { file: "sales_book.html", name: "Sales History", icon: "fa-file-invoice-dollar" },
        { file: "purchase_book.html", name: "Purchase Book", icon: "fa-clipboard-list" },
        { file: "due_book.html", name: "Due Ledger", icon: "fa-book-open" },
        { file: "cashbox.html", name: "Cash Box", icon: "fa-cash-register" },
        { file: "expenses_book.html", name: "Expenses", icon: "fa-wallet" },
        { file: "sales_return.html", name: "Sales Return", icon: "fa-undo-alt" },
        { file: "purchase_return.html", name: "Purchase Return", icon: "fa-share" },
        { file: "reports.html", name: "Reports & AI", icon: "fa-chart-pie" },
        { file: "settings.html", name: "Shop Settings", icon: "fa-cog" },
        { file: "app_access.html", name: "Team & Access", icon: "fa-shield-halved" }
    ];

    window.onload = () => {
        // Theme sync
        rtdb.ref(`global_settings/header_theme`).on('value', (snap) => {
            const themeCode = snap.exists() ? snap.val().code : null;
            if (themeCode && themeCode.trim() !== "") {
                document.getElementById('dynamicThemeContainer').innerHTML = themeCode;
                document.body.classList.add('has-theme');
            } else {
                document.getElementById('dynamicThemeContainer').innerHTML = "";
                document.body.classList.remove('has-theme');
            }
        });

        renderPermissionCheckboxes();
        loadUsersAndCheckSecurity();
    };

    function renderPermissionCheckboxes() {
        const container = document.getElementById('permList');
        container.innerHTML = ALL_PAGES.map(p => `
            <div class="perm-check" id="div_${p.file.replace('.html', '')}" onclick="toggleCheck('${p.file}')">
                <input type="checkbox" id="perm_${p.file}" value="${p.file}">
                <i class="fas ${p.icon}" style="color: #9ca3af;" id="icon_${p.file.replace('.html', '')}"></i>
                <span>${p.name}</span>
            </div>
        `).join('');
    }

    window.toggleCheck = (file) => {
        const role = document.getElementById('userRole').value;
        const phoneBeingEdited = document.getElementById('userPhone').value;
        
        let myRealRole = currentShopData.roles ? currentShopData.roles[myPhone] : 'staff';
        if (currentShopData.createdBy === myPhone || currentShopData.phone === myPhone) myRealRole = 'owner';
        
        if (myRealRole === 'owner' && myPhone === phoneBeingEdited) return; 
        if(role !== 'custom') return; 
        
        const cb = document.getElementById(`perm_${file}`);
        cb.checked = !cb.checked;
        updateCheckStyle(file);
    };

    function updateCheckStyle(file) {
        const idSafe = file.replace('.html', '');
        const cb = document.getElementById(`perm_${file}`);
        const div = document.getElementById(`div_${idSafe}`);
        const icon = document.getElementById(`icon_${idSafe}`);
        
        if(cb.checked) { div.classList.add('active'); icon.style.color = 'var(--primary)'; } 
        else { div.classList.remove('active'); icon.style.color = '#9ca3af'; }
    }

    function loadUsersAndCheckSecurity() {
        dbFirestore.collection("shops").doc(shopId).get().then(docSnap => {
            if (docSnap.exists) {
                currentShopData = docSnap.data();

                let realRole = 'staff';
                if (currentShopData.roles && currentShopData.roles[myPhone]) { realRole = currentShopData.roles[myPhone]; }
                if (currentShopData.createdBy === myPhone || currentShopData.phone === myPhone) { realRole = 'owner'; }

                let hasAccess = false;
                if (realRole === 'owner') hasAccess = true;
                if (currentShopData.permissions && currentShopData.permissions[myPhone] && currentShopData.permissions[myPhone]['app_access.html'] === true) hasAccess = true;

                if (!hasAccess) {
                    alert("Access Denied! üö´\n‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡ßá‡¶á‡•§");
                    window.location.replace("home.html");
                    return; 
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('userList').style.display = 'grid';
                document.getElementById('fabAdd').style.display = 'flex';

                const members = currentShopData.members || [];
                const staffInfo = currentShopData.staff_info || {};
                const listDiv = document.getElementById('userList');
                listDiv.innerHTML = "";

                if(members.length === 0) listDiv.innerHTML = "<p style='text-align:center; grid-column: 1/-1;'>No members found.</p>";

                members.forEach(phone => {
                    const info = staffInfo[phone] || {};
                    let roleKey = currentShopData.roles ? currentShopData.roles[phone] : 'staff';
                    if (currentShopData.createdBy === phone || currentShopData.phone === phone) roleKey = 'owner';
                    
                    let displayRole = roleKey;
                    if(roleKey === 'custom' && info.customTitle) displayRole = info.customTitle;

                    const imgUrl = info.image || 'https://via.placeholder.com/150';
                    const name = info.name || "Unknown User";
                    
                    const borderClass = `border-${roleKey}`;
                    const badgeClass = `badge-${roleKey}`;
                    
                    const canEdit = (realRole === 'owner' || myPhone === phone);

                    const card = `
                        <div class="user-card ${borderClass}" onclick="${canEdit ? `openModal('edit', '${phone}')` : ''}">
                            <img src="${imgUrl}" class="user-img">
                            <div class="user-info">
                                <h3 class="user-name">${name} ${myPhone === phone ? '<span style="color:var(--primary)">(You)</span>' : ''}</h3>
                                <span class="role-badge ${badgeClass}">${displayRole}</span>
                                <div class="details-row"><span><i class="fas fa-id-badge"></i> ${phone}</span></div>
                            </div>
                            ${canEdit ? '<i class="fas fa-chevron-right" style="color:#cbd5e1;"></i>' : ''}
                        </div>
                    `;
                    listDiv.innerHTML += card;
                });
            } else {
                document.getElementById('loading').innerHTML = "Shop details not found.";
            }
        }).catch(e => {
            console.error(e); alert("Error loading data.");
        });
    }

    window.openModal = (mode, phone = '') => {
        document.getElementById('userModal').style.display = "flex";
        
        const phoneInput = document.getElementById('userPhone');
        phoneInput.value = ""; phoneInput.disabled = false;
        
        document.getElementById('userName').value = "";
        document.getElementById('joinDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('imgInput').value = "";
        document.getElementById('imgPreview').src = "https://via.placeholder.com/150";
        document.getElementById('userRole').value = "staff";
        document.getElementById('saveBtn').innerHTML = "Add Member";
        document.getElementById('deleteBtn').style.display = 'none';

        document.getElementById('userName').disabled = false;
        document.getElementById('joinDate').disabled = false;
        document.getElementById('userRole').disabled = false;
        document.getElementById('imgInput').disabled = false;
        document.getElementById('customTitle').disabled = false;
        document.getElementById('imgChangeText').style.display = 'block';

        let myRealRole = currentShopData.roles ? currentShopData.roles[myPhone] : 'staff';
        if (currentShopData.createdBy === myPhone || currentShopData.phone === myPhone) myRealRole = 'owner';

        if (mode === 'edit') {
            document.getElementById('modalTitle').innerText = "Edit Member";
            const info = currentShopData.staff_info[phone] || {};
            let role = currentShopData.roles[phone] || 'staff';
            if (currentShopData.createdBy === phone || currentShopData.phone === phone) role = 'owner';
            
            const perms = currentShopData.permissions ? currentShopData.permissions[phone] : {};

            phoneInput.value = phone; phoneInput.disabled = true; 
            document.getElementById('userName').value = info.name || "";
            document.getElementById('joinDate').value = info.joinDate || "";
            document.getElementById('imgPreview').src = info.image || "https://via.placeholder.com/150";
            document.getElementById('userRole').value = role;
            document.getElementById('saveBtn').innerHTML = "Update Details";
            
            if(myRealRole === 'owner' && myPhone === phone) {
                document.getElementById('userRole').disabled = true;
                document.getElementById('customTitle').disabled = true;
                document.querySelectorAll('.perm-check').forEach(div => div.classList.add('disabled'));
            } else {
                document.querySelectorAll('.perm-check').forEach(div => div.classList.remove('disabled'));
            }

            if(role === 'custom') {
                document.getElementById('customTitle').value = info.customTitle || "";
                ALL_PAGES.forEach(p => {
                    const cb = document.getElementById(`perm_${p.file}`);
                    cb.checked = (perms[p.file] === true);
                    updateCheckStyle(p.file);
                });
            } else {
                handleRoleChange();
            }
            
            if(myRealRole === 'owner' && myPhone !== phone) {
                document.getElementById('deleteBtn').style.display = 'block';
            }
        } else {
            document.getElementById('modalTitle').innerText = "Add New Member";
            document.querySelectorAll('.perm-check').forEach(div => div.classList.remove('disabled'));
            handleRoleChange();
        }
        
        handleRoleChange(); 
    };

    window.closeModal = () => { document.getElementById('userModal').style.display = "none"; };

    window.handleRoleChange = () => {
        const role = document.getElementById('userRole').value;
        const customBox = document.getElementById('customTitleBox');
        const checkboxes = document.querySelectorAll('.perm-check input');

        if (role === 'custom') {
            customBox.style.display = 'block';
            document.querySelectorAll('.perm-check').forEach(div => { div.style.opacity = "1"; });
        } else {
            customBox.style.display = 'none';
            document.querySelectorAll('.perm-check').forEach(div => { div.style.opacity = "0.5"; });

            checkboxes.forEach(cb => {
                const file = cb.value;
                let isChecked = false;
                
                if (role === 'owner') isChecked = true; 
                else if (role === 'manager') isChecked = !['app_access.html', 'settings.html'].includes(file); 
                else if (role === 'staff') isChecked = ['sell.html', 'product_list.html', 'sales_return.html'].includes(file);
                
                cb.checked = isChecked;
                updateCheckStyle(file);
            });
        }
    };

    window.previewImage = (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('imgPreview').src = e.target.result; }
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.saveUser = async () => {
        const btn = document.getElementById('saveBtn');
        const phone = document.getElementById('userPhone').value.trim();
        const name = document.getElementById('userName').value.trim();
        const role = document.getElementById('userRole').value;
        const joinDate = document.getElementById('joinDate').value;
        const fileInput = document.getElementById('imgInput');

        if (!phone || !name) return alert("Please enter valid Login ID (Phone/Email) and Name.");

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        try {
            const userDocRef = dbFirestore.collection("users").doc(phone);
            const userDoc = await userDocRef.get();
            if (!userDoc.exists) {
                const proceed = confirm(`‚ö†Ô∏è Warning\n\nLogin ID: ${phone} is not registered in Stashio yet.\n\nThey must create an account using this exact ID to access your shop.\n\nProceed anyway?`);
                if (!proceed) { btn.disabled = false; btn.innerHTML = "Save Member"; return; }
            }

            let imageUrl = document.getElementById('imgPreview').src;
            if (fileInput.files && fileInput.files[0]) {
                const formData = new FormData();
                formData.append("image", fileInput.files[0]);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
                const data = await res.json();
                if(data.data) imageUrl = data.data.url;
            }

            let perms = {};
            ALL_PAGES.forEach(p => {
                if(document.getElementById(`perm_${p.file}`).checked) perms[p.file] = true;
            });

            let finalRole = role;
            let finalPerms = perms;
            
            let myRealRole = currentShopData.roles ? currentShopData.roles[myPhone] : 'staff';
            if (currentShopData.createdBy === myPhone || currentShopData.phone === myPhone) myRealRole = 'owner';

            if(myRealRole === 'owner' && myPhone === phone) {
                finalRole = currentShopData.roles[phone] || 'owner';
                finalPerms = currentShopData.permissions ? currentShopData.permissions[phone] : {};
            }

            const staffData = { name: name, joinDate: joinDate, image: imageUrl, customTitle: (finalRole === 'custom') ? document.getElementById('customTitle').value : "" };
            const shopRef = dbFirestore.collection("shops").doc(shopId);
            
            const updateData = {};
            updateData.members = firebase.firestore.FieldValue.arrayUnion(phone);
            updateData[`roles.${phone}`] = finalRole;
            updateData[`permissions.${phone}`] = finalPerms;
            updateData[`staff_info.${phone}`] = staffData;

            await shopRef.update(updateData);
            
            if(userDoc.exists) {
                await userDocRef.update({ shops: firebase.firestore.FieldValue.arrayUnion(shopId) });
            }

            if(myPhone === phone) {
                localStorage.setItem('myRole', finalRole);
                localStorage.setItem('myPermissions', JSON.stringify(finalPerms));
            }

            closeModal();
            loadUsersAndCheckSecurity(); 
            
        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
        } finally {
            btn.disabled = false;
        }
    };

    window.deleteUser = async () => {
        const phone = document.getElementById('userPhone').value;
        if (!confirm("Are you sure you want to REVOKE ACCESS for this user? They will no longer see this shop on their dashboard.")) return;

        try {
            const shopRef = dbFirestore.collection("shops").doc(shopId);
            const userDocRef = dbFirestore.collection("users").doc(phone);
            
            const updateData = {};
            updateData.members = firebase.firestore.FieldValue.arrayRemove(phone);
            updateData[`roles.${phone}`] = firebase.firestore.FieldValue.delete();
            updateData[`permissions.${phone}`] = firebase.firestore.FieldValue.delete();
            updateData[`staff_info.${phone}`] = firebase.firestore.FieldValue.delete();
            
            await shopRef.update(updateData);
            
            const userDoc = await userDocRef.get();
            if (userDoc.exists) {
                await userDocRef.update({ shops: firebase.firestore.FieldValue.arrayRemove(shopId) });
            }

            closeModal();
            loadUsersAndCheckSecurity();

        } catch(e) {
            alert("Error removing user.");
        }
    };
</script>

</body>
</html>
