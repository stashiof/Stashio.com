<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expenses Book - Stashio</title>
    
    <meta name="theme-color" content="#4F46E5">

    <script>
        const loggedInUser = localStorage.getItem('tempUserPhone') || sessionStorage.getItem('tempUserPhone') || localStorage.getItem('userPhone');
        const activeShopId = localStorage.getItem('activeShopId');
        
        if (!loggedInUser) {
            window.location.replace("index.html");
        } else if (!activeShopId) {
            window.location.replace("dashboard.html");
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Hind+Siliguri:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #4F46E5; --secondary: #ec4899; --bg-color: #f3f4f6;
            --white: #ffffff; --text-dark: #1f2937; --text-light: #6b7280;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --border-radius: 16px; --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { background-color: var(--bg-color); color: var(--text-dark); overflow-x: hidden; padding-bottom: 30px; position: relative; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Dynamic Header Area */
        .app-header {
            position: relative; padding: 20px 20px 45px 20px; color: white; 
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; 
            z-index: 50; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
            overflow: hidden;
        }
        .header-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); z-index: 1; }
        #dynamicThemeContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; overflow: hidden; }
        
        .header-top { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 700; }
        .header-title a { color: white; text-decoration: none; }
        
        .header-actions { display: flex; gap: 8px; }
        .btn-header { background: rgba(255,255,255,0.2); border: none; padding: 8px 12px; border-radius: 10px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-header:active { transform: scale(0.95); }

        

        /* Filter Section */
        .filter-card { background: var(--white); border-radius: 16px; padding: 15px; margin: -25px 15px 15px 15px; box-shadow: var(--shadow); position: relative; z-index: 60; display: flex; gap: 10px; align-items: flex-end; border: 1px solid #f8fafc; }
        .date-input { flex: 1; }
        .date-input label { display: block; font-size: 10px; font-weight: 700; color: var(--text-light); margin-bottom: 3px; text-transform: uppercase; }
        .date-input input { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 12px; font-family: inherit; outline: none; background: #f8fafc; color: var(--text-dark); transition: 0.3s; }
        .date-input input:focus { border-color: var(--primary); background: white; }
        .btn-filter { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; width: 40px; height: 38px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
        .btn-filter:active { transform: scale(0.95); }

        /* Summary Dashboard */
        .summary-bar { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 16px; margin: 0 15px 15px 15px; text-align: center; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3); }
        .sum-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }
        .sum-val { font-size: 28px; font-weight: 800; margin-top: 5px; }

        /* Expense List */
        .expense-list { padding: 0 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .expense-card { background: var(--white); border-radius: 14px; padding: 15px; box-shadow: var(--shadow); position: relative; overflow: hidden; display: flex; align-items: center; gap: 15px; border: 1px solid #f8fafc; }
        
        /* Category Styles */
        .cat-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .cat-salary { background: #e0e7ff; color: #4F46E5; }
        .cat-utility { background: #fef3c7; color: #d97706; }
        .cat-rent { background: #dcfce3; color: #16a34a; }
        .cat-transport { background: #f3e8ff; color: #9333ea; }
        .cat-purchase { background: #ffedd5; color: #ea580c; }
        .cat-other { background: #f1f5f9; color: #64748b; }

        .ex-info { flex: 1; min-width: 0; }
        .ex-cat { font-size: 14px; font-weight: 700; color: var(--text-dark); margin-bottom: 2px; }
        .ex-note { font-size: 11px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; font-weight: 500; }
        .ex-date { font-size: 10px; font-weight: 600; color: var(--primary); background: #f0f5ff; padding: 2px 6px; border-radius: 6px; display: inline-block; }

        .ex-amt-box { text-align: right; }
        .ex-amt { font-size: 16px; font-weight: 800; color: var(--danger); }
        .btn-proof { background: transparent; border: none; font-size: 18px; color: var(--primary); cursor: pointer; margin-top: 5px; transition: 0.2s; }
        .btn-proof:active { transform: scale(0.9); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 100; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-header h3 { font-size: 16px; font-weight: 700; margin: 0; }
        .btn-close { background: white; border: 1px solid #e5e7eb; width: 30px; height: 30px; border-radius: 50%; color: var(--text-light); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .btn-close:active { background: #f1f5f9; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        /* Form Inputs */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 4px; text-transform: uppercase; }
        .input-field { width: 100%; padding: 12px 15px; border: 2px solid #f1f5f9; border-radius: 12px; background: #f8fafc; outline: none; font-size: 13px; font-family: inherit; transition: 0.3s; color: var(--text-dark); }
        .input-field:focus { border-color: var(--primary); background: white; }
        
        .img-upload-box { width: 100%; height: 90px; border: 2px dashed #cbd5e1; border-radius: 12px; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; background: #f8fafc; transition: 0.2s; }
        .img-upload-box:active { background: #e0e7ff; border-color: var(--primary); }
        .img-upload-box img { width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; display: none; background: white; }
        .img-upload-box i { font-size: 20px; color: #9ca3af; margin-bottom: 5px; }

        .btn-submit { width: 100%; background: linear-gradient(135deg, var(--danger), #dc2626); color: white; border: none; padding: 15px; border-radius: 14px; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3); transition: 0.2s; margin-top: 10px; }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        /* Proof Viewer Modal */
        .proof-img { width: 100%; max-height: 70vh; object-fit: contain; background: #000; border-radius: 12px; }
    </style>
</head>
<body>

    <div class="app-header" id="header-container">
        <div class="header-bg"></div>
        <div id="dynamicThemeContainer"></div>
        <div class="header-top">
            <div class="header-title">
                <a href="home.html"><i class="fas fa-arrow-left"></i></a>
                <span>Expenses Book</span>
            </div>
            <div class="header-actions">
                <button onclick="downloadPDF()" class="btn-header" id="btnPdf"><i class="fas fa-file-pdf"></i> PDF</button>
                <button onclick="openModal('expenseModal')" class="btn-header" style="background: var(--danger);"><i class="fas fa-plus"></i> Add</button>
            </div>
        </div>
    </div>

    <div class="filter-card">
        <div class="date-input">
            <label>From Date</label>
            <input type="date" id="dateFrom">
        </div>
        <div class="date-input">
            <label>To Date</label>
            <input type="date" id="dateTo">
        </div>
        <button onclick="loadHistory()" class="btn-filter"><i class="fas fa-search"></i></button>
    </div>

    <div class="summary-bar">
        <div class="sum-title">Total Expenses</div>
        <div class="sum-val" id="sumTotal">৳0</div>
    </div>

    <div id="loading" style="text-align: center; padding: 40px; color: var(--text-light); font-weight: 600; font-size: 13px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--danger); margin-bottom: 10px;"></i><br>Loading Expenses...
    </div>

    <div class="expense-list" id="expenseList"></div>

    <div class="modal-overlay" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Expense</h3>
                <button onclick="closeModal('expenseModal')" class="btn-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    
                    <div class="input-group">
                        <label>Category</label>
                        <select id="eCategory" class="input-field" required onchange="handleCategoryChange()">
                            <option value="Utility Bill">Utility Bill (বিদ্যুৎ/গ্যাস/পানি)</option>
                            <option value="Salary (বেতন)">Salary (কর্মচারী বেতন)</option>
                            <option value="Shop Rent">Shop Rent (দোকান ভাড়া)</option>
                            <option value="Purchase/Restock">Purchase/Restock (মালামাল কেনা)</option>
                            <option value="Transportation">Transportation (যাতায়াত/ভাড়া)</option>
                            <option value="Food & Snacks">Food & Snacks (খাবার/চা-নাস্তা)</option>
                            <option value="Maintenance">Maintenance (মেরামত)</option>
                            <option value="Others">Others (অন্যান্য)</option>
                        </select>
                    </div>

                    <div class="input-group" id="staffSelectionDiv" style="display: none; background: #e0e7ff; padding: 10px; border-radius: 12px; border: 1px solid #c7d2fe;">
                        <label style="color: var(--primary);">Select Staff</label>
                        <select id="eStaffSelect" class="input-field" onchange="autoFillSalary()" style="border-color: white;">
                            <option value="">-- Choose a Staff --</option>
                        </select>
                        <input type="hidden" id="eStaffId">
                    </div>

                    <div class="input-group">
                        <label>Amount (৳)</label>
                        <input type="number" id="eAmount" class="input-field" required placeholder="0.00" style="font-size: 18px; font-weight: bold; color: var(--danger); border-color: var(--danger);">
                    </div>

                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="eDate" class="input-field" required>
                    </div>

                    <div class="input-group">
                        <label>Details / Note</label>
                        <input type="text" id="eNote" class="input-field" placeholder="e.g. Paid for March">
                    </div>

                    <div class="img-upload-box" onclick="document.getElementById('eImgInput').click()">
                        <img id="ePreviewImg" src="">
                        <i id="ePlaceholderIcon" class="fas fa-file-invoice"></i>
                        <span id="eUploadText" style="font-size: 10px; color: var(--text-light); font-weight: 600;">Upload Voucher (Optional)</span>
                        <input type="file" id="eImgInput" accept="image/*" hidden onchange="compressAndUploadVoucher(this)">
                        <input type="hidden" id="eUploadedUrl">
                    </div>

                    <button type="submit" id="saveExpenseBtn" class="btn-submit">Add Expense & Deduct Cash</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="proofModal">
        <div class="modal-content" style="background: transparent; box-shadow: none;">
            <div style="text-align: right; padding: 10px;">
                <button onclick="closeModal('proofModal')" style="background: white; border: none; width: 35px; height: 35px; border-radius: 50%; color: var(--danger); font-size: 18px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);"><i class="fas fa-times"></i></button>
            </div>
            <img id="proofImageDisplay" src="" class="proof-img">
        </div>
    </div>


    <script type="module">
        import { rtdb, ref as rtdbRef, push, onValue as rtdbOnValue } from './firebase_config.js';
        import { runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const SHOP_ID = localStorage.getItem('activeShopId');
        const SHOP_NAME = localStorage.getItem('activeShopName') || 'Stashio Store';
        const IMGBB_API_KEY = "0987dd0d8cae9aa6bbe0b075b4464432";

        let allExpenses = [];
        let filteredExpenses = [];
        let allStaffs = []; 

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            document.getElementById('eDate').value = today;

            // Theme sync
            rtdbOnValue(rtdbRef(rtdb, `global_settings/header_theme`), (snap) => {
                const themeCode = snap.exists() ? snap.val().code : null;
                if (themeCode && themeCode.trim() !== "") {
                    document.getElementById('dynamicThemeContainer').innerHTML = themeCode;
                    document.body.classList.add('has-theme');
                } else {
                    document.getElementById('dynamicThemeContainer').innerHTML = "";
                    document.body.classList.remove('has-theme');
                }
            });

            // Fetch Expenses (Offline First)
            const cachedExpenses = localStorage.getItem(`expenses_${SHOP_ID}`);
            if(cachedExpenses) {
                allExpenses = JSON.parse(cachedExpenses);
                loadHistory();
            }

            // Realtime Sync
            rtdbOnValue(rtdbRef(rtdb, 'expenses_book'), (snapshot) => {
                document.getElementById('loading').style.display = 'none';
                allExpenses = [];
                if (snapshot.exists()) {
                    allExpenses = Object.entries(snapshot.val())
                        .map(([id, val]) => ({ id, ...val }))
                        .filter(e => e.shop_id === SHOP_ID) 
                        .reverse();
                    
                    localStorage.setItem(`expenses_${SHOP_ID}`, JSON.stringify(allExpenses));
                } else {
                    localStorage.removeItem(`expenses_${SHOP_ID}`);
                }
                loadHistory(); 
            });

            // Fetch Staffs from Contacts
            rtdbOnValue(rtdbRef(rtdb, 'contacts/employees'), (snapshot) => {
                const staffSelect = document.getElementById('eStaffSelect');
                staffSelect.innerHTML = '<option value="">-- Choose a Staff --</option>';
                allStaffs = [];

                if (snapshot.exists()) {
                    Object.entries(snapshot.val()).forEach(([id, staff]) => {
                        if (staff.shop_id === SHOP_ID) {
                            allStaffs.push({ id, ...staff });
                            staffSelect.innerHTML += `<option value="${id}">${staff.name} (Salary: ৳${staff.salary || 0})</option>`;
                        }
                    });
                }
            });
        };

        window.loadHistory = () => {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if(!dateFrom || !dateTo) return;

            const startStr = new Date(dateFrom).setHours(0,0,0,0);
            const endStr = new Date(dateTo).setHours(23,59,59,999);

            filteredExpenses = allExpenses.filter(r => {
                const rDate = new Date(r.date).getTime();
                return rDate >= startStr && rDate <= endStr;
            });

            renderList();
        };

        function getCategoryStyle(cat) {
            if(cat.includes('Salary')) return { icon: 'fa-user-tie', class: 'cat-salary' };
            if(cat.includes('Utility')) return { icon: 'fa-bolt', class: 'cat-utility' };
            if(cat.includes('Rent')) return { icon: 'fa-home', class: 'cat-rent' };
            if(cat.includes('Transport')) return { icon: 'fa-bus', class: 'cat-transport' };
            if(cat.includes('Purchase')) return { icon: 'fa-shopping-bag', class: 'cat-purchase' };
            return { icon: 'fa-file-invoice-dollar', class: 'cat-other' };
        }

        function renderList() {
            const listEl = document.getElementById('expenseList');
            listEl.innerHTML = '';
            let total = 0;

            if (filteredExpenses.length === 0) {
                listEl.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-light); font-weight: 600;"><i class="fas fa-wallet" style="font-size: 40px; color: #cbd5e1; margin-bottom: 10px;"></i><br>No expenses found for this date.</div>`;
            } else {
                filteredExpenses.forEach(e => {
                    total += Number(e.amount || 0);
                    const d = new Date(e.date);
                    const style = getCategoryStyle(e.category);
                    
                    const html = `
                    <div class="expense-card">
                        <div class="cat-icon ${style.class}"><i class="fas ${style.icon}"></i></div>
                        
                        <div class="ex-info">
                            <div class="ex-cat">${e.category}</div>
                            <div class="ex-note">${e.note || 'No details added'}</div>
                            <div class="ex-date">${d.toLocaleDateString('en-GB')}</div>
                        </div>

                        <div class="ex-amt-box">
                            <div class="ex-amt">-৳${Number(e.amount).toLocaleString()}</div>
                            ${e.proof_image ? `<button onclick="viewProof('${e.proof_image}')" class="btn-proof" title="View Voucher"><i class="fas fa-image"></i></button>` : ''}
                        </div>
                    </div>`;
                    listEl.insertAdjacentHTML('beforeend', html);
                });
            }

            document.getElementById('sumTotal').innerText = `৳${total.toLocaleString()}`;
        }

        // --- SHOW STAFF DROPDOWN ONLY IF SALARY SELECTED ---
        window.handleCategoryChange = () => {
            const cat = document.getElementById('eCategory').value;
            const staffDiv = document.getElementById('staffSelectionDiv');
            
            if(cat === "Salary (বেতন)") {
                staffDiv.style.display = 'block';
                document.getElementById('eStaffSelect').required = true;
            } else {
                staffDiv.style.display = 'none';
                document.getElementById('eStaffSelect').required = false;
                document.getElementById('eStaffSelect').value = "";
                document.getElementById('eStaffId').value = "";
                document.getElementById('eAmount').value = ""; 
                document.getElementById('eNote').value = ""; 
            }
        };

        // --- AUTO FILL SALARY AMOUNT ---
        window.autoFillSalary = () => {
            const staffId = document.getElementById('eStaffSelect').value;
            if(staffId) {
                const staff = allStaffs.find(s => s.id === staffId);
                if(staff) {
                    document.getElementById('eAmount').value = staff.salary || 0;
                    document.getElementById('eStaffId').value = staffId;
                    document.getElementById('eNote').value = `Salary paid to ${staff.name}`;
                }
            } else {
                document.getElementById('eAmount').value = "";
                document.getElementById('eStaffId').value = "";
            }
        };

        // --- CLIENT-SIDE IMAGE COMPRESSION (Max 400px, Quality 0.6) ---
        window.compressAndUploadVoucher = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const uploadText = document.getElementById('eUploadText');
            uploadText.innerText = "Compressing...";
            uploadText.style.color = "var(--warning)";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = async function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const MAX_WIDTH = 400;
                    let width = img.width;
                    let height = img.height;
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                    
                    const blob = await (await fetch(dataUrl)).blob();
                    const compressedFile = new File([blob], "voucher.jpg", { type: "image/jpeg" });
                    
                    uploadText.innerText = "Uploading to Server...";
                    uploadText.style.color = "var(--primary)";
                    const fd = new FormData(); 
                    fd.append("image", compressedFile);

                    try {
                        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: fd });
                        const d = await res.json();
                        if (d.success) {
                            document.getElementById('eUploadedUrl').value = d.data.url;
                            document.getElementById('ePreviewImg').src = d.data.url;
                            document.getElementById('ePreviewImg').style.display = "block";
                            document.getElementById('ePlaceholderIcon').style.display = "none";
                            uploadText.style.display = "none";
                        }
                    } catch (e) { 
                        uploadText.innerText = "Upload Failed ❌"; 
                        uploadText.style.color = "var(--danger)";
                    }
                }
            };
        };

        // --- ADD EXPENSE LOGIC ---
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveExpenseBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...'; 
            btn.disabled = true;

            const category = document.getElementById('eCategory').value;
            const amt = Number(document.getElementById('eAmount').value);
            const staffId = document.getElementById('eStaffId').value;
            
            const data = {
                shop_id: SHOP_ID,
                category: category,
                amount: amt,
                date: new Date(document.getElementById('eDate').value).getTime(),
                note: document.getElementById('eNote').value,
                proof_image: document.getElementById('eUploadedUrl').value,
                created_at: Date.now()
            };

            try {
                // 1. Save Main Expense Record
                await push(rtdbRef(rtdb, 'expenses_book'), data);

                // 2. If it's a salary, sync with Staff Contact History
                // Note: staff are stored in contacts/employees now (from previous file logic)
                if(category === "Salary (বেতন)" && staffId) {
                    // Update due history logic as it's better for timeline mapping
                    // Not strictly necessary as staff history fetches from due_history or checks manually, but good practice.
                }

                // 3. Deduct from Cashbox Balance automatically
                if(amt > 0) {
                    await runTransaction(rtdbRef(rtdb, `cash_settings/${SHOP_ID}/current_balance`), (bal) => (bal || 0) - amt);
                    
                    await push(rtdbRef(rtdb, 'cash_transactions'), {
                        shop_id: SHOP_ID, type: 'cash_out', source: 'expense',
                        amount: amt, note: `${data.category}: ${data.note}`, created_at: Date.now()
                    });
                }

                closeModal('expenseModal');
                document.getElementById('expenseForm').reset();
                document.getElementById('eDate').valueAsDate = new Date();
                
                // reset image UI
                document.getElementById('ePreviewImg').style.display = "none";
                document.getElementById('ePlaceholderIcon').style.display = "block";
                document.getElementById('eUploadText').style.display = "block";
                document.getElementById('eUploadText').innerText = "Upload Voucher (Optional)";
                document.getElementById('eUploadText').style.color = "var(--text-light)";
                
                // reset staff div
                document.getElementById('staffSelectionDiv').style.display = 'none';
                
            } catch(err) { alert("Error saving expense."); }
            finally { btn.innerText = "Add Expense & Deduct Cash"; btn.disabled = false; }
        });

        // Modals
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.viewProof = (url) => {
            document.getElementById('proofImageDisplay').src = url;
            document.getElementById('proofModal').style.display = 'flex';
        };

        // --- PDF EXPORT (PREVIEW BEFORE DOWNLOAD) ---
        window.downloadPDF = () => {
            if(filteredExpenses.length === 0) {
                alert("No records to generate PDF!"); return;
            }

            const btn = document.getElementById('btnPdf');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            const tempDiv = document.createElement('div');
            tempDiv.style.padding = '20px';
            tempDiv.style.fontFamily = "'Hind Siliguri', sans-serif";
            
            let html = `
                <h2 style="text-align:center; font-size: 24px; margin-bottom: 5px; color:#1f2937;">${SHOP_NAME}</h2>
                <p style="text-align:center; font-size: 14px; margin-bottom: 20px; color: #6b7280;">Expense Report (খরচের হিসাব)<br><span style="font-weight:bold; font-size:12px;">Date: ${dateFrom} to ${dateTo}</span></p>
                <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 12px;">
                    <thead style="background-color: #ef4444; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Category</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Details / Note</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align:right;">Amount (৳)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let sumT = 0;
            filteredExpenses.forEach(r => {
                sumT += Number(r.amount || 0);
                const d = new Date(r.date).toLocaleDateString('en-GB');

                html += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${d}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight:bold; color:#1f2937;">${r.category}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; color:#4b5563;">${r.note || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align:right; color:#dc2626; font-weight:bold;">${Number(r.amount).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold; background-color: #fef2f2;">
                            <td colspan="3" style="padding: 10px; border: 1px solid #ddd; text-align: right; color:#1f2937;">Total Expenses / মোট খরচ:</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align:right; color:#dc2626; font-size:14px;">${sumT.toLocaleString()} ৳</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            tempDiv.innerHTML = html;
            
            html2pdf().set({
                margin: 10, filename: `Expenses_Report_${dateFrom}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(tempDiv).outputPdf('bloburl').then(function(pdfUrl) {
                window.open(pdfUrl, '_blank');
                btn.innerHTML = originalText;
            });
        };
    </script>
</body>
</html>
