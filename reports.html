<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analytics & Insights - Stashio</title>
    
    <meta name="theme-color" content="#4F46E5">

    <script>
        const loggedInUser = localStorage.getItem('tempUserPhone') || sessionStorage.getItem('tempUserPhone') || localStorage.getItem('userPhone');
        const activeShopId = localStorage.getItem('activeShopId');
        if (!loggedInUser) { window.location.replace("index.html"); } 
        else if (!activeShopId) { window.location.replace("dashboard.html"); }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #4F46E5; --secondary: #ec4899; --bg-color: #f3f4f6;
            --white: #ffffff; --text-dark: #1f2937; --text-light: #6b7280;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --blue: #3b82f6; --purple: #8b5cf6; --orange: #f97316; --gold: #ffd700;
            --border-radius: 20px; --shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { background-color: var(--bg-color); color: var(--text-dark); padding-bottom: 90px; overflow-x: hidden; position: relative; }
        a { text-decoration: none; color: inherit; }

        /* Dynamic Header Area (Same as Home) */
        .app-header {
            position: relative; padding: 30px 20px 50px 20px; color: white; 
            border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; 
            margin-bottom: -30px; overflow: hidden; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
        }
        .header-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); z-index: 1; }
        #dynamicThemeContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        .header-content { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; }
        .header-content p { font-size: 12px; font-weight: 500; opacity: 0.9; margin-top: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); background: rgba(255, 255, 255, 0.15); padding: 3px 10px; border-radius: 10px; display: inline-block; }

        body.has-theme .app-header { box-shadow: none; border-bottom: 1px solid rgba(255,255,255,0.3); }

        /* Insights Grid */
        .insights-container { margin: -25px 15px 20px 15px; position: relative; z-index: 10; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .insight-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: var(--border-radius); padding: 20px 15px; box-shadow: var(--shadow); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 120px; cursor: pointer; transition: 0.2s; border: 1px solid #f8fafc; }
        .insight-card:active { transform: scale(0.96); box-shadow: 0 5px 10px rgba(0,0,0,0.05); }
        .insight-icon { position: absolute; right: -10px; bottom: -10px; font-size: 60px; opacity: 0.08; z-index: 1; }
        
        .ic-header { font-size: 11px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px; z-index: 2; position: relative; display: flex; align-items: center; gap: 5px; }
        .ic-title { font-size: 14px; font-weight: 800; color: var(--text-dark); line-height: 1.3; z-index: 2; position: relative; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ic-value { font-size: 12px; font-weight: 600; margin-top: 5px; z-index: 2; position: relative; padding: 4px 8px; border-radius: 8px; display: inline-block; width: fit-content; }

        .card-best-sell .ic-header i { color: var(--blue); } .card-best-sell .ic-value { background: #dbeafe; color: var(--blue); }
        .card-profit .ic-header i { color: var(--success); } .card-profit .ic-value { background: #dcfce3; color: var(--success); }
        .card-worst .ic-header i { color: var(--danger); } .card-worst .ic-value { background: #fee2e2; color: var(--danger); }
        .card-customer .ic-header i { color: var(--warning); } .card-customer .ic-value { background: #fef3c7; color: var(--warning); }

        /* Returns Section */
        .section-title { font-size: 15px; font-weight: 800; margin: 25px 15px 15px 15px; color: var(--text-dark); display: flex; align-items: center; position: relative; z-index: 10; }
        .section-title::before { content: ''; display: inline-block; width: 5px; height: 18px; background: var(--danger); border-radius: 5px; margin-right: 10px; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 0 15px 25px 15px; position: relative; z-index: 10; }
        .action-btn { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px 15px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--shadow); transition: 0.2s; border: 1px solid #f1f5f9; display: flex; flex-direction: column; align-items: center; }
        .action-btn:active { transform: scale(0.96); }
        
        .ab-icon { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 10px; }
        .icon-sr { background: #fee2e2; color: var(--danger); } .icon-pr { background: #ffedd5; color: var(--orange); }
        .ab-title { font-size: 13px; font-weight: 800; color: var(--text-dark); margin-bottom: 2px; }
        .ab-sub { font-size: 10px; color: var(--text-light); font-weight: 500; }

        /* List Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
        .modal-content { background: var(--bg-color); width: 100%; max-width: 500px; height: 85vh; border-top-left-radius: 25px; border-top-right-radius: 25px; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { padding: 20px; background: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .btn-close { background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 50%; color: var(--text-dark); font-size: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        
        .list-item { background: white; padding: 15px; border-radius: 14px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); position: relative; }
        .rank-badge { width: 35px; height: 35px; border-radius: 10px; background: #f1f5f9; color: var(--text-dark); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; flex-shrink: 0; }
        .rank-1 { background: #fef08a; color: #a16207; box-shadow: 0 0 10px rgba(234, 179, 8, 0.3); border: 1px solid #fde047; }
        .rank-2 { background: #e2e8f0; color: #475569; }
        .rank-3 { background: #ffedd5; color: #9a3412; }
        
        .li-info { flex: 1; min-width: 0; }
        .li-name { font-size: 13px; font-weight: 700; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .li-val { font-size: 11px; font-weight: 600; color: var(--primary); }
        .li-action { font-size: 10px; background: linear-gradient(135deg, var(--warning), var(--orange)); color: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Premium Certificate Design */
        #certModalOverlay { display: none; align-items: center; justify-content: center; padding: 15px; }
        #certModalContent { height: auto; max-height: 95vh; border-radius: 20px; background: transparent; animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; width: 100%; max-width: 400px; display: flex; flex-direction: column; }
        @keyframes zoomIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #printableWrapper { flex: 1; overflow: hidden; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 2px solid #5a4a2a; }
        #printableCertificate {
            background: radial-gradient(circle at 50% 0%, #2a2a2a 0%, #0a0a0a 100%);
            color: white; padding: 35px 25px; position: relative; text-align: center;
            font-family: 'Poppins', sans-serif; height: 100%;
        }
        .cert-border { position: absolute; inset: 10px; border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 12px; pointer-events: none; }
        .cert-border::before, .cert-border::after { content: '♦'; position: absolute; color: var(--gold); font-size: 18px; line-height: 1; }
        .cert-border::before { top: -10px; left: -8px; }
        .cert-border::after { bottom: -10px; right: -8px; }
        .cert-icon { font-size: 55px; color: var(--gold); margin-bottom: 10px; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6)); display: inline-block; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .cert-title { font-size: 11px; color: #fef08a; text-transform: uppercase; letter-spacing: 4px; font-weight: 700; margin-bottom: 5px; opacity: 0.9; }
        .cert-award { font-size: 26px; font-weight: 800; color: white; margin-bottom: 25px; line-height: 1.2; text-transform: uppercase; background: -webkit-linear-gradient(#fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cert-ribbon { width: 60px; height: 2px; background: var(--gold); margin: 0 auto 20px auto; box-shadow: 0 0 10px var(--gold); }
        .cert-presented { font-size: 10px; color: #9ca3af; margin-bottom: 5px; letter-spacing: 1px; }
        .cert-name { font-size: 28px; font-weight: 800; color: var(--gold); margin-bottom: 25px; line-height: 1.2; text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3); }
        .cert-quote { font-size: 12px; color: #e2e8f0; font-style: italic; line-height: 1.6; padding: 0 20px; margin-bottom: 35px; position: relative; }
        .cert-quote::before { content: '"'; font-size: 40px; color: rgba(255,215,0,0.2); position: absolute; top: -15px; left: 0; font-family: serif; }
        .cert-footer { border-top: 1px solid rgba(255,215,0,0.2); padding-top: 15px; font-size: 10px; color: #9ca3af; display: flex; justify-content: space-between; align-items: flex-end; }
        .signature-line { width: 100px; height: 1px; background: rgba(255,255,255,0.3); margin-top: 25px; margin-bottom: 5px; }

        .cert-action-box { background: white; padding: 15px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 -10px 20px rgba(0,0,0,0.1); margin-top: -5px; position: relative; z-index: 5; }
        .btn-download-cert { background: linear-gradient(135deg, var(--gold), #d97706); color: #451a03; border: none; padding: 14px; border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 15px; box-shadow: 0 5px 15px rgba(217, 119, 6, 0.4); text-transform: uppercase; letter-spacing: 1px; }
        .btn-close-cert { position: absolute; top: -15px; right: -15px; background: var(--danger); color: white; border: 2px solid white; width: 35px; height: 35px; border-radius: 50%; font-size: 16px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 20; }

        /* Bottom Nav styles needed for body.has-theme (Wait, dynamic nav handles this) */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: var(--white); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 25px rgba(0,0,0,0.08); border-top-left-radius: 30px; border-top-right-radius: 30px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9ca3af; flex: 1; height: 100%; position: relative; transition: 0.3s; cursor: pointer; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item span { font-size: 11px; font-weight: 700; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-4px); }
        .nav-item.active::after { content: ''; position: absolute; top: 12px; right: 35%; width: 6px; height: 6px; background: var(--secondary); border-radius: 50%; }

        #loading { text-align: center; padding: 40px; color: var(--text-dark); font-weight: 600; font-size: 13px; position: absolute; top: 150px; width: 100%; z-index: 20; }
        body.has-theme #loading { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="header-container" class="app-header"></div>
    
    <div id="loading"><i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i><br>Analyzing Data...</div>

    <div class="insights-container" id="insightsData" style="opacity: 0; transition: opacity 0.5s;">
        
        <div class="insight-card card-best-sell" onclick="openListModal('top_qty')">
            <i class="fas fa-box-open insight-icon"></i>
            <div>
                <div class="ic-header"><i class="fas fa-fire"></i> Top Selling</div>
                <div class="ic-title" id="valTopProduct">Analyzing...</div>
            </div>
            <div class="ic-value" id="valTopQty">0 pcs</div>
        </div>

        <div class="insight-card card-profit" onclick="openListModal('top_profit')">
            <i class="fas fa-hand-holding-usd insight-icon"></i>
            <div>
                <div class="ic-header"><i class="fas fa-chart-line"></i> Highest Profit</div>
                <div class="ic-title" id="valProfitProduct">Analyzing...</div>
            </div>
            <div class="ic-value" id="valProfitAmt">৳0 earned</div>
        </div>

        <div class="insight-card card-customer" onclick="openListModal('top_customers')">
            <i class="fas fa-crown insight-icon"></i>
            <div>
                <div class="ic-header"><i class="fas fa-star"></i> Best Customer</div>
                <div class="ic-title" id="valBestCustomer">Analyzing...</div>
            </div>
            <div class="ic-value" id="valCustomerAmt">৳0 value</div>
        </div>

        <div class="insight-card card-worst" onclick="openListModal('worst_qty')">
            <i class="fas fa-arrow-trend-down insight-icon"></i>
            <div>
                <div class="ic-header"><i class="fas fa-exclamation-triangle"></i> Slowest Sales</div>
                <div class="ic-title" id="valWorstProduct">Analyzing...</div>
            </div>
            <div class="ic-value" id="valWorstQty">0 pcs</div>
        </div>

    </div>

    <div class="section-title">Returns & Adjustments</div>
    <div class="action-grid">
        <a href="sales_return.html" class="action-btn">
            <div class="ab-icon icon-sr"><i class="fas fa-undo-alt"></i></div>
            <div class="ab-title">Sales Return</div>
            <div class="ab-sub">Customer Return</div>
        </a>
        <a href="purchase_return.html" class="action-btn">
            <div class="ab-icon icon-pr"><i class="fas fa-share"></i></div>
            <div class="ab-title">Purchase Return</div>
            <div class="ab-sub">Return to Supplier</div>
        </a>
    </div>

    <div class="modal-overlay" id="listModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="listModalTitle" style="margin: 0; font-size: 16px;">Detailed List</h3>
                <button onclick="document.getElementById('listModal').style.display='none'" class="btn-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="listModalBody"></div>
        </div>
    </div>

    <div class="modal-overlay" id="certModalOverlay">
        <div class="modal-content" id="certModalContent">
            <button onclick="document.getElementById('certModalOverlay').style.display='none'" class="btn-close-cert"><i class="fas fa-times"></i></button>
            <div id="printableWrapper">
                <div id="printableCertificate">
                    <div class="cert-border"></div>
                    <i class="fas fa-crown cert-icon"></i>
                    <div class="cert-title">Stashio Excellence</div>
                    <div class="cert-award">Premium Partner Award</div>
                    <div class="cert-ribbon"></div>
                    <div class="cert-presented">PROUDLY PRESENTED TO</div>
                    <div class="cert-name" id="certCustName">Company Name</div>
                    <div class="cert-quote" id="certQuote"></div>
                    <div class="cert-footer">
                        <div style="text-align: left;">
                            <div class="signature-line"></div>
                            <span style="display:block; font-weight:800; color:var(--gold); font-size:12px; letter-spacing: 1px;" id="certShopName">Shop Name</span>
                            <span style="font-size: 8px; text-transform: uppercase;">Authorized Signature</span>
                        </div>
                        <div style="text-align: right;">
                            <i class="fas fa-award" style="font-size: 30px; color: rgba(255,215,0,0.3); margin-bottom: 5px;"></i>
                            <span style="display:block; font-weight:bold; color:white;">2026</span>
                            <span style="font-size: 8px; text-transform: uppercase;">Year of Excellence</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="cert-action-box">
                <button onclick="downloadCertificate()" class="btn-download-cert" id="btnDownloadCert">
                    <i class="fas fa-download"></i> Download Award Card
                </button>
            </div>
        </div>
    </div>

    <div id="bottom-nav-container" class="bottom-nav"></div>

    <script type="module">
        // মডুলার ফায়ারবেস ইমপোর্ট
        import { rtdb, ref as rtdbRef, onValue as rtdbOnValue } from './firebase_config.js';

        const SHOP_ID = localStorage.getItem('activeShopId');
        const SHOP_NAME = localStorage.getItem('activeShopName') || 'Stashio Store';

        // Header & Footer Load Function
        async function loadComponents() {
            try {
                // Header Load
                const headerRes = await fetch('header.html');
                if (headerRes.ok) {
                    document.getElementById('header-container').innerHTML = await headerRes.text();
                    
                    // এখানে রিপোর্ট পেজের জন্য টেক্সট পরিবর্তন করা হচ্ছে
                    document.getElementById('shopTitle').innerHTML = `<i class="fas fa-brain" style="color: #fef08a;"></i> AI Insights`;
                    const subText = document.querySelector('.header-content p');
                    if(subText) subText.innerText = "Tap any card for detailed list";
                    
                    // Header Theme Sync
                    rtdbOnValue(rtdbRef(rtdb, `global_settings/header_theme`), (snap) => {
                        const themeCode = snap.exists() ? snap.val().code : null;
                        if (themeCode && themeCode.trim() !== "") {
                            document.getElementById('dynamicThemeContainer').innerHTML = themeCode;
                            document.body.classList.add('has-theme');
                        } else {
                            document.getElementById('dynamicThemeContainer').innerHTML = "";
                            document.body.classList.remove('has-theme');
                        }
                    });
                }

                // Bottom Nav Load
                const navRes = await fetch('bottom_nav.html');
                if (navRes.ok) {
                    document.getElementById('bottom-nav-container').innerHTML = await navRes.text();
                    // রিপোর্ট পেজের মেন্যুটি এক্টিভ করা হচ্ছে
                    document.getElementById('nav-reports').classList.add('active');
                }
            } catch (error) {
                console.error("Error loading components:", error);
            }
        }

        let sortedByQty = []; let sortedByProfit = []; let sortedCustomers = []; let sortedWorst = [];

        window.onload = () => {
            loadComponents(); // 컴পোনেন্ট লোড কল করা
            document.getElementById('certShopName').innerText = SHOP_NAME;

            // Data Analysis Logic
            rtdbOnValue(rtdbRef(rtdb, 'sales_history'), (snap) => {
                let productSalesQty = {}; let productProfit = {}; let customerPurchases = {};

                if(snap.exists()) {
                    Object.values(snap.val()).forEach(sale => {
                        if(sale.shop_id === SHOP_ID && !sale.is_deleted) {
                            let custName = sale.customer || sale.customer_name;
                            if(!custName || custName.trim() === "") custName = "Walk-in Customer";
                            customerPurchases[custName] = (customerPurchases[custName] || 0) + Number(sale.total_amount || 0);

                            if(sale.items && Array.isArray(sale.items)) {
                                sale.items.forEach(item => {
                                    let pName = item.name; let qty = Number(item.qty || 0); let profit = Number(item.profit || 0); 
                                    if(profit === 0 && item.sellRate && item.buyRate) { profit = (item.sellRate - item.buyRate) * qty; }
                                    productSalesQty[pName] = (productSalesQty[pName] || 0) + qty;
                                    productProfit[pName] = (productProfit[pName] || 0) + profit;
                                });
                            }
                        }
                    });
                }

                sortedByQty = Object.entries(productSalesQty).map(([name, val]) => ({name, val})).sort((a,b) => b.val - a.val);
                sortedByProfit = Object.entries(productProfit).map(([name, val]) => ({name, val})).sort((a,b) => b.val - a.val);
                sortedWorst = [...sortedByQty].reverse(); 
                
                const realCustomers = Object.entries(customerPurchases).filter(([name, val]) => !name.toLowerCase().includes("walk-in"));
                sortedCustomers = realCustomers.map(([name, val]) => ({name, val})).sort((a,b) => b.val - a.val);

                document.getElementById('valTopProduct').innerText = sortedByQty.length > 0 ? sortedByQty[0].name : "No Data";
                document.getElementById('valTopQty').innerText = sortedByQty.length > 0 ? `${sortedByQty[0].val} pcs` : "0 pcs";

                document.getElementById('valProfitProduct').innerText = sortedByProfit.length > 0 ? sortedByProfit[0].name : "No Data";
                document.getElementById('valProfitAmt').innerText = sortedByProfit.length > 0 ? `৳${sortedByProfit[0].val.toLocaleString()}` : "৳0";

                document.getElementById('valBestCustomer').innerText = sortedCustomers.length > 0 ? sortedCustomers[0].name : "No Data";
                document.getElementById('valCustomerAmt').innerText = sortedCustomers.length > 0 ? `৳${sortedCustomers[0].val.toLocaleString()}` : "৳0";

                document.getElementById('valWorstProduct').innerText = sortedWorst.length > 0 ? sortedWorst[0].name : "No Data";
                document.getElementById('valWorstQty').innerText = sortedWorst.length > 0 ? `${sortedWorst[0].val} pcs` : "0 pcs";

                document.getElementById('loading').style.display = 'none';
                document.getElementById('insightsData').style.opacity = '1';
            });
        };

        // Modal Functions
        window.openListModal = (type) => {
            const titleEl = document.getElementById('listModalTitle'); const bodyEl = document.getElementById('listModalBody');
            bodyEl.innerHTML = ''; let dataArray = []; let valuePrefix = ''; let valueSuffix = ''; let isCustomer = false;

            if(type === 'top_qty') { titleEl.innerHTML = '<i class="fas fa-fire text-blue"></i> Top Selling Items'; dataArray = sortedByQty; valueSuffix = ' pcs'; } 
            else if(type === 'top_profit') { titleEl.innerHTML = '<i class="fas fa-chart-line text-success"></i> Most Profitable Items'; dataArray = sortedByProfit; valuePrefix = '৳'; }
            else if(type === 'worst_qty') { titleEl.innerHTML = '<i class="fas fa-arrow-trend-down text-danger"></i> Slowest Items'; dataArray = sortedWorst; valueSuffix = ' pcs'; }
            else if(type === 'top_customers') { titleEl.innerHTML = '<i class="fas fa-crown text-warning"></i> Best Customers Ranking'; dataArray = sortedCustomers; valuePrefix = '৳'; isCustomer = true; }

            if(dataArray.length === 0) { bodyEl.innerHTML = '<div style="text-align:center; padding:30px; color:#9ca3af;">No data available yet.</div>'; } 
            else {
                dataArray.forEach((item, index) => {
                    const rank = index + 1; let rankClass = rank <= 3 ? `rank-${rank}` : '';
                    let valDisplay = `${valuePrefix}${item.val.toLocaleString()}${valueSuffix}`;
                    let actionBtnHtml = '';
                    if(isCustomer && rank <= 5) { actionBtnHtml = `<div class="li-action" onclick="openCertificate('${item.name.replace(/'/g, "\\'")}', ${rank})"><i class="fas fa-award"></i> View Award</div>`; }
                    const html = `
                    <div class="list-item">
                        <div class="rank-badge ${rankClass}">#${rank}</div>
                        <div class="li-info">
                            <div class="li-name">${item.name} ${isCustomer && rank <= 5 ? '<i class="fas fa-star text-warning" style="font-size:10px;"></i>' : ''}</div>
                            <div class="li-val">${valDisplay}</div>
                        </div>
                        ${actionBtnHtml}
                    </div>`;
                    bodyEl.insertAdjacentHTML('beforeend', html);
                });
            }
            document.getElementById('listModal').style.display = 'flex';
        };

        window.openCertificate = (name, rank) => {
            document.getElementById('listModal').style.display = 'none'; document.getElementById('certCustName').innerText = name;
            const quoteEl = document.getElementById('certQuote');
            if(rank === 1) { quoteEl.innerText = `"Our #1 Premium Partner! Your outstanding support and loyalty drive our mutual success. You are the heart of our business."`; } 
            else if (rank === 2 || rank === 3) { quoteEl.innerText = `"A true pillar of our business! Thank you for the amazing journey together. We deeply value your continuous trust."`; } 
            else { quoteEl.innerText = `"Exceptional partnership! We are honored to serve you and look forward to achieving more milestones together."`; }
            document.getElementById('certModalOverlay').style.display = 'flex';
        };

        window.downloadCertificate = () => {
            const btn = document.getElementById('btnDownloadCert'); const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            const element = document.getElementById('printableCertificate'); const custName = document.getElementById('certCustName').innerText;
            html2pdf().set({
                margin: 0, filename: `Stashio_Award_${custName}.pdf`, image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, useCORS: true, backgroundColor: '#0a0a0a' },
                jsPDF: { unit: 'mm', format: [120, 160], orientation: 'portrait' } 
            }).from(element).save().then(() => { btn.innerHTML = originalHTML; });
        };
    </script>
</body>
</html>
