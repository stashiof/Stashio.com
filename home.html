<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stashio - Home Dashboard</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    
    <script>
        // শুধুমাত্র localStorage ব্যবহার করা হচ্ছে
        const loggedInUser = localStorage.getItem('userPhone') || localStorage.getItem('tempUserPhone');
        const activeShopId = localStorage.getItem('activeShopId');
        
        // লগইন বা শপ সিলেক্ট না থাকলে রিডাইরেক্ট
        if (!loggedInUser) {
            window.location.replace("index.html");
        } else if (!activeShopId) {
            window.location.replace("dashboard.html");
        }
    </script>
 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4F46E5; --secondary: #ec4899; --bg-color: #f3f4f6;
            --white: #ffffff; --text-dark: #1f2937; --text-light: #6b7280;
            --green: #10b981; --red: #ef4444; --blue: #3b82f6; --orange: #f59e0b;
            --purple: #8b5cf6; --teal: #14b8a6; --border-radius: 20px;
            --shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { background-color: var(--bg-color); color: var(--text-dark); padding-bottom: 90px; overflow-x: hidden; }
        a { text-decoration: none; color: inherit; display: block; }

        /* Dynamic Header Area */
        .app-header {
            position: relative; padding: 30px 20px 50px 20px; color: white; 
            border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; 
            margin-bottom: -30px; overflow: hidden; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
        }
        .header-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); z-index: 1; }
        #dynamicThemeContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        .header-content { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; }
        .header-content p { font-size: 12px; font-weight: 500; opacity: 0.9; margin-top: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); background: rgba(255, 255, 255, 0.15); padding: 3px 10px; border-radius: 10px; display: inline-block; }

        /* Live Dashboard Stats */
        .dashboard-card { background: var(--white); border-radius: var(--border-radius); padding: 25px 20px; box-shadow: var(--shadow); margin: 0 15px 20px 15px; position: relative; z-index: 20; }
        .dash-row { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px dashed #f3f4f6; padding-bottom: 20px; }
        .dash-row:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
        .stat-item { text-align: center; flex: 1; position: relative; }
        .stat-item:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 15%; height: 70%; width: 1px; background: #e5e7eb; }
        .stat-label { font-size: 11px; color: var(--text-light); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 18px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .val-green { color: var(--green); } .val-red { color: var(--red); } .val-blue { color: var(--blue); }

        /* Actions */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 0 15px 25px 15px; }
        .big-btn { background: var(--white); padding: 20px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--shadow); transition: 0.2s; position: relative; overflow: hidden; border: 1px solid #f8fafc; }
        .big-btn:active { transform: scale(0.96); box-shadow: 0 5px 10px rgba(0,0,0,0.05); }
        .icon-box-large { width: 65px; height: 65px; margin: 0 auto 12px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .bg-orange-light { background: #fef3c7; color: var(--orange); }
        .bg-blue-light { background: #dbeafe; color: var(--blue); }
        .big-btn span { font-size: 16px; font-weight: 800; color: var(--text-dark); display: block; }

        /* Menu Sections */
        .section-container { background: var(--white); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); margin: 0 15px 20px 15px; border: 1px solid #f8fafc; }
        .section-title { font-size: 15px; font-weight: 800; margin-bottom: 20px; color: var(--text-dark); display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 5px; height: 18px; background: var(--primary); border-radius: 5px; margin-right: 10px; }

        .icon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 10px; text-align: center; }
        .grid-item { display: flex; flex-direction: column; align-items: center; transition: 0.2s; cursor: pointer; }
        .grid-item:active { transform: scale(0.92); opacity: 0.8; }
        .icon-box { width: 48px; height: 48px; border-radius: 16px; background: #f8fafc; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; font-size: 22px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .grid-label { font-size: 11px; font-weight: 600; color: var(--text-light); line-height: 1.2; word-wrap: break-word; }

        .text-orange { color: var(--orange); } .text-blue { color: var(--blue); } .text-green { color: var(--green); }
        .text-red { color: var(--red); } .text-purple { color: var(--purple); } .text-teal { color: var(--teal); } .text-dark { color: #374151; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: var(--white); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 25px rgba(0,0,0,0.08); border-top-left-radius: 30px; border-top-right-radius: 30px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9ca3af; flex: 1; height: 100%; position: relative; transition: 0.3s; cursor: pointer; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item span { font-size: 11px; font-weight: 700; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-4px); }
        .nav-item.active::after { content: ''; position: absolute; top: 12px; right: 35%; width: 6px; height: 6px; background: var(--secondary); border-radius: 50%; }
        
        .loading-spinner { font-size: 14px; color: #cbd5e1; }
    </style>
</head>
<body>

    <div id="header-container" class="app-header"></div>

    <div class="dashboard-card">
        <div class="dash-row">
            <div class="stat-item">
                <a href="cashbox.html">
                    <div class="stat-label">Current Balance</div>
                    <div class="stat-value val-green" id="dashBalance"><i class="fas fa-spinner fa-spin loading-spinner"></i></div>
                </a>
            </div>
            <div class="stat-item" style="flex: 1.5;"> 
                <div class="stat-label">Today's Sales</div>
                <a href="sales_book.html">
                    <div class="stat-value val-blue" id="dashSales"><i class="fas fa-spinner fa-spin loading-spinner"></i></div>
                </a>
            </div>
        </div>

        <div class="dash-row">
            <div class="stat-item">
                <a href="expenses_book.html">
                    <div class="stat-label">Today's Exp.</div>
                    <div class="stat-value val-red" id="dashExpense"><i class="fas fa-spinner fa-spin loading-spinner"></i></div>
                </a>
            </div>
            <div class="stat-item">
                <a href="due_book.html">
                    <div class="stat-label">Total Dues</div>
                    <div style="font-size: 11px; color: var(--green); font-weight: 700; margin-bottom: 2px;" id="dashDueGet">Recv: <i class="fas fa-spinner fa-spin loading-spinner"></i></div>
                    <div style="font-size: 11px; color: var(--red); font-weight: 700;" id="dashDuePay">Pay: <i class="fas fa-spinner fa-spin loading-spinner"></i></div>
                </a>
            </div>
            <div class="stat-item">
                <a href="stock_book.html">
                    <div class="stat-label">Stock Qty</div>
                    <div class="stat-value val-green" id="dashStock"><i class="fas fa-spinner fa-spin loading-spinner"></i></div>
                </a>
            </div>
        </div>
    </div>

    <div class="action-grid">
        <a href="purchase.html" class="big-btn">
            <div class="icon-box-large bg-orange-light"><i class="fa-solid fa-cart-shopping"></i></div>
            <span>Purchase</span>
        </a>
        <a href="sell.html" class="big-btn">
            <div class="icon-box-large bg-blue-light"><i class="fa-solid fa-bag-shopping"></i></div>
            <span>Sell</span>
        </a>
    </div>

    <div class="section-container">
        <div class="section-title">Ledger Books</div>
        <div class="icon-grid">
            <a href="purchase_book.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-clipboard-list text-orange"></i></div>
                <div class="grid-label">Purchase<br>Book</div>
            </a>
            <a href="sales_book.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-file-invoice-dollar text-blue"></i></div>
                <div class="grid-label">Sales<br>Book</div>
            </a>
            <a href="due_book.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-book-open text-purple"></i></div>
                <div class="grid-label">Due<br>Book</div>
            </a>
            <a href="expenses_book.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-wallet text-red"></i></div>
                <div class="grid-label">Expense<br>Book</div>
            </a>
        </div>
    </div>

    <div class="section-container">
        <div class="section-title">Business Management</div>
        <div class="icon-grid">
            <a href="contacts.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-users text-teal"></i></div>
                <div class="grid-label">Contacts</div>
            </a>
            <a href="product_list.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-box-open text-orange"></i></div>
                <div class="grid-label">Product<br>List</div>
            </a>
            <a href="stock_book.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-boxes-stacked text-green"></i></div>
                <div class="grid-label">Stock<br>Report</div>
            </a>
            <a href="business_report.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-chart-line text-blue"></i></div>
                <div class="grid-label">Business<br>Report</div>
            </a>
        </div>
    </div>

    <div class="section-container" style="margin-bottom: 40px;">
        <div class="section-title">Utilities & Security</div>
        <div class="icon-grid">
            <a href="cashbox.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-cash-register text-green"></i></div>
                <div class="grid-label">Cash Box</div>
            </a>
            <a href="sales_return.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-undo-alt text-red"></i></div>
                <div class="grid-label">Sales<br>Return</div>
            </a>
            <a href="purchase_return.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-share text-orange"></i></div>
                <div class="grid-label">Purchase<br>Return</div>
            </a>
            <a href="expire_product.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-calendar-xmark text-red"></i></div>
                <div class="grid-label">Expire<br>Items</div>
            </a>
            <a href="app_access.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-shield-halved text-purple"></i></div>
                <div class="grid-label">App Access</div>
            </a>
            <a href="barcode_gen.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-barcode text-purple"></i></div>
                <div class="grid-label">Barcode<br>Gen</div>
            </a>
            <a href="printer.html" class="grid-item">
                <div class="icon-box"><i class="fa-solid fa-print text-dark"></i></div>
                <div class="grid-label">Printer</div>
            </a>
        </div>
    </div>

    <div id="bottom-nav-container" class="bottom-nav"></div>

    <script type="module">
        import { rtdb, ref as rtdbRef, onValue as rtdbOnValue } from './firebase_config.js';
        
        const SHOP_ID = localStorage.getItem('activeShopId');
        const SHOP_NAME = localStorage.getItem('activeShopName');

        async function loadComponents() {
            try {
                // Header Load
                const headerRes = await fetch('header.html');
                if (headerRes.ok) {
                    document.getElementById('header-container').innerHTML = await headerRes.text();
                    if(SHOP_NAME) document.getElementById('shopTitle').innerHTML = `<span style="color:#fef08a;">✨</span> ${SHOP_NAME}`;
                    
                    // --- Header Theme Sync With Page Permissions ---
                    rtdbOnValue(rtdbRef(rtdb, `global_settings/header_theme`), (snap) => {
                        if (snap.exists()) {
                            const data = snap.val();
                            let currentPage = window.location.pathname.split('/').pop() || 'home.html';
                            
                            if (data.code && data.allowed_pages && data.allowed_pages[currentPage]) {
                                document.getElementById('dynamicThemeContainer').innerHTML = data.code;
                            } else {
                                document.getElementById('dynamicThemeContainer').innerHTML = ""; 
                            }
                        } else {
                            document.getElementById('dynamicThemeContainer').innerHTML = "";
                        }
                    });
                }

                // Bottom Nav Load
                const navRes = await fetch('bottom_nav.html');
                if (navRes.ok) {
                    document.getElementById('bottom-nav-container').innerHTML = await navRes.text();
                    document.getElementById('nav-home').classList.add('active');
                }
            } catch (error) {
                console.error("Error loading components:", error);
            }
        }
        
        window.onload = () => {
            loadComponents();

            const todayStr = new Date().setHours(0,0,0,0);
            
            // 1. Get Live Cash Balance
            rtdbOnValue(rtdbRef(rtdb, `cash_settings/${SHOP_ID}/current_balance`), (snap) => {
                const bal = snap.val() || 0;
                document.getElementById('dashBalance').innerText = `৳${bal.toLocaleString()}`;
            });

            // 2. Get Today's Sales
            rtdbOnValue(rtdbRef(rtdb, 'sales_history'), (snap) => {
                let todaySales = 0;
                if(snap.exists()) {
                    Object.values(snap.val()).forEach(s => {
                        if(s.shop_id === SHOP_ID && (s.created_at || new Date(s.date).getTime()) >= todayStr) {
                            todaySales += Number(s.total_amount || 0);
                        }
                    });
                }
                document.getElementById('dashSales').innerText = `৳${todaySales.toLocaleString()}`;
            });

            // 3. Get Today's Expenses
            rtdbOnValue(rtdbRef(rtdb, 'expenses_book'), (snap) => {
                let todayExp = 0;
                if(snap.exists()) {
                    Object.values(snap.val()).forEach(e => {
                        if(e.shop_id === SHOP_ID && e.date >= todayStr) {
                            todayExp += Number(e.amount || 0);
                        }
                    });
                }
                document.getElementById('dashExpense').innerText = `৳${todayExp.toLocaleString()}`;
            });

            // 4. Get Total Due 
            rtdbOnValue(rtdbRef(rtdb, 'due_book'), (snap) => {
                let toRecv = 0, toPay = 0;
                if(snap.exists()) {
                    Object.values(snap.val()).forEach(d => {
                        if(d.shop_id === SHOP_ID && d.current_due > 0) {
                            if(d.type === 'receive') toRecv += Number(d.current_due);
                            if(d.type === 'pay') toPay += Number(d.current_due);
                        }
                    });
                }
                document.getElementById('dashDueGet').innerText = `Recv: ৳${toRecv.toLocaleString()}`;
                document.getElementById('dashDuePay').innerText = `Pay: ৳${toPay.toLocaleString()}`;
            });

            // 5. Get Total Stock Qty
            rtdbOnValue(rtdbRef(rtdb, 'product_list'), (snap) => {
                let totalQty = 0;
                if(snap.exists()) {
                    Object.values(snap.val()).forEach(p => {
                        if(p.shop_id === SHOP_ID && !p.is_deleted) {
                            totalQty += Number(p.stock || 0);
                        }
                    });
                }
                document.getElementById('dashStock').innerText = totalQty.toLocaleString();
            });
        };
    </script>
</body>
</html>
