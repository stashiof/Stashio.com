<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Book - Stashio</title>
    
    <meta name="theme-color" content="#4F46E5">

    <script>
        const loggedInUser = localStorage.getItem('tempUserPhone') || sessionStorage.getItem('tempUserPhone') || localStorage.getItem('userPhone');
        const activeShopId = localStorage.getItem('activeShopId');
        
        if (!loggedInUser) {
            window.location.replace("index.html");
        } else if (!activeShopId) {
            window.location.replace("dashboard.html");
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Hind+Siliguri:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #4F46E5; --secondary: #ec4899; --bg-color: #f3f4f6;
            --white: #ffffff; --text-dark: #1f2937; --text-light: #6b7280;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --border-radius: 16px; --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { background-color: var(--bg-color); color: var(--text-dark); overflow-x: hidden; padding-bottom: 30px; position: relative; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Dynamic Header Area */
        .app-header {
            position: relative; padding: 20px 20px 45px 20px; color: white; 
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; 
            z-index: 50; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
            overflow: hidden;
        }
        .header-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); z-index: 1; }
        #dynamicThemeContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; overflow: hidden; }
        
        .header-top { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 700; }
        .header-title a { color: white; text-decoration: none; }
        .btn-pdf { background: rgba(255,255,255,0.2); border: none; padding: 8px 12px; border-radius: 10px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-pdf:active { transform: scale(0.95); }

        body.has-theme .app-header { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); box-shadow: none; border-bottom: 1px solid rgba(255,255,255,0.3); }
        body.has-theme .header-bg { display: none; }

        /* Filter Section */
        .filter-card { background: var(--white); border-radius: 16px; padding: 15px; margin: -25px 15px 15px 15px; box-shadow: var(--shadow); position: relative; z-index: 60; display: flex; gap: 10px; align-items: flex-end; border: 1px solid #f8fafc; }
        .date-input { flex: 1; }
        .date-input label { display: block; font-size: 10px; font-weight: 700; color: var(--text-light); margin-bottom: 3px; text-transform: uppercase; }
        .date-input input { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 12px; outline: none; background: #f8fafc; color: var(--text-dark); font-family: inherit;}
        .btn-filter { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; width: 40px; height: 38px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
        .btn-filter:active { transform: scale(0.95); }

        /* Summary */
        .summary-bar { display: flex; justify-content: space-between; padding: 0 15px; margin-bottom: 15px; }
        .sum-box { flex: 1; background: var(--white); padding: 12px; border-radius: 12px; text-align: center; box-shadow: var(--shadow); border: 1px solid #f8fafc; }
        .sum-box:first-child { margin-right: 10px; }
        .sum-title { font-size: 10px; font-weight: 600; color: var(--text-light); text-transform: uppercase; }
        .sum-val { font-size: 16px; font-weight: 800; margin-top: 2px; }

        /* List */
        .history-list { padding: 0 15px; display: flex; flex-direction: column; gap: 12px; }
        .history-card { background: var(--white); border-radius: 14px; padding: 15px; box-shadow: var(--shadow); position: relative; overflow: hidden; border-left: 4px solid var(--success); border-top: 1px solid #f8fafc; border-right: 1px solid #f8fafc; border-bottom: 1px solid #f8fafc; }
        .history-card.has-due { border-left-color: var(--danger); }
        
        .hc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px dashed #e5e7eb; padding-bottom: 10px; }
        .hc-supp { font-size: 14px; font-weight: 700; color: var(--text-dark); }
        .hc-date { font-size: 11px; color: var(--text-light); font-weight: 500; }
        .hc-inv { font-size: 10px; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; font-family: monospace; font-weight: 600; margin-top: 4px; display: inline-block; color: var(--text-dark); }

        .hc-body { display: flex; justify-content: space-between; align-items: flex-end; }
        .hc-items { font-size: 12px; color: var(--text-light); font-weight: 600; }
        .hc-amt-box { text-align: right; }
        .hc-total { font-size: 16px; font-weight: 800; color: var(--text-dark); line-height: 1; }
        .hc-paid { font-size: 11px; color: var(--success); font-weight: 600; margin-top: 4px; }
        .hc-due { font-size: 11px; color: var(--danger); font-weight: 600; margin-top: 2px; }

        .btn-view { background: #f8fafc; border: 1px solid #e5e7eb; width: 100%; padding: 8px; border-radius: 10px; font-size: 12px; font-weight: 600; color: var(--primary); margin-top: 10px; cursor: pointer; transition: 0.2s; }
        .btn-view:active { background: #f1f5f9; }
        
        /* Receipt Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index: 100; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 16px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; font-size: 12px; color: var(--text-dark); }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
        th { text-align: left; color: var(--text-light); font-weight: 600; text-transform: uppercase; font-size: 10px; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
    </style>
</head>
<body>

    <div class="app-header" id="header-container">
        <div class="header-bg"></div>
        <div id="dynamicThemeContainer"></div>
        <div class="header-top">
            <div class="header-title">
                <a href="home.html"><i class="fas fa-arrow-left"></i></a>
                <span>Sales Book</span>
            </div>
            <button onclick="downloadPDF()" class="btn-pdf"><i class="fas fa-file-pdf"></i> Save PDF</button>
        </div>
    </div>

    <div class="filter-card">
        <div class="date-input">
            <label>From Date</label>
            <input type="date" id="dateFrom">
        </div>
        <div class="date-input">
            <label>To Date</label>
            <input type="date" id="dateTo">
        </div>
        <button onclick="loadHistory()" class="btn-filter"><i class="fas fa-search"></i></button>
    </div>

    <div class="summary-bar">
        <div class="sum-box">
            <div class="sum-title">Total Sales</div>
            <div class="sum-val text-success" id="sumTotal">৳0</div>
        </div>
        <div class="sum-box">
            <div class="sum-title text-danger">Total Due</div>
            <div class="sum-val text-danger" id="sumDue">৳0</div>
        </div>
    </div>

    <div id="loading" style="text-align: center; padding: 40px; color: var(--text-light); font-weight: 600; font-size: 13px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary); margin-bottom: 10px;"></i><br>Loading Sales...
    </div>

    <div class="history-list" id="historyList"></div>

    <div class="modal-overlay" id="receiptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-size: 16px; font-weight: 700; margin: 0;">Sales Details</h3>
                <button onclick="document.getElementById('receiptModal').style.display='none'" style="background: #f1f5f9; border: none; width: 30px; height: 30px; border-radius: 50%; color: var(--text-dark); cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="receiptContent">
            </div>
        </div>
    </div>

    <script type="module">
        // মডুলার ফায়ারবেস ইমপোর্ট
        import { rtdb, ref as rtdbRef, onValue as rtdbOnValue } from './firebase_config.js';
        
        const SHOP_ID = localStorage.getItem('activeShopId');
        const SHOP_NAME = localStorage.getItem('activeShopName') || 'Stashio Store';

        let allRecords = [];
        let filteredRecords = [];
        
        let globalPdfTemplateCode = ""; 
        let shopLogoImgUrl = ""; 

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;

            // Theme sync
            rtdbOnValue(rtdbRef(rtdb, `global_settings/header_theme`), (snap) => {
                const themeCode = snap.exists() ? snap.val().code : null;
                if (themeCode && themeCode.trim() !== "") {
                    document.getElementById('dynamicThemeContainer').innerHTML = themeCode;
                    document.body.classList.add('has-theme');
                } else {
                    document.getElementById('dynamicThemeContainer').innerHTML = "";
                    document.body.classList.remove('has-theme');
                }
            });

            // Fetch Dynamic PDF Template from Admin
            rtdbOnValue(rtdbRef(rtdb, `global_settings/pdf_sales_template`), (snap) => {
                if(snap.exists()) globalPdfTemplateCode = snap.val().code || "";
            });

            // Fetch Shop Logo
            rtdbOnValue(rtdbRef(rtdb, `shops/${SHOP_ID}`), (snap) => {
                if(snap.exists() && snap.val().image) shopLogoImgUrl = snap.val().image;
            });

            // Fetch Sales History (Offline Cache First)
            const cachedSales = localStorage.getItem(`sales_history_${SHOP_ID}`);
            if(cachedSales) {
                allRecords = JSON.parse(cachedSales);
                loadHistory();
            }

            // Realtime Sync
            rtdbOnValue(rtdbRef(rtdb, 'sales_history'), (snapshot) => {
                document.getElementById('loading').style.display = 'none';
                if (snapshot.exists()) {
                    allRecords = Object.entries(snapshot.val())
                        .map(([id, val]) => ({ id, ...val }))
                        .filter(r => r.shop_id === SHOP_ID) 
                        .reverse();
                    
                    localStorage.setItem(`sales_history_${SHOP_ID}`, JSON.stringify(allRecords));
                } else {
                    allRecords = [];
                    localStorage.removeItem(`sales_history_${SHOP_ID}`);
                }
                loadHistory(); 
            });
        };

        window.loadHistory = () => {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if(!dateFrom || !dateTo) {
                alert("Please select both dates."); return;
            }

            const startStr = new Date(dateFrom).setHours(0,0,0,0);
            const endStr = new Date(dateTo).setHours(23,59,59,999);

            filteredRecords = allRecords.filter(r => {
                const saleDate = r.created_at || (r.date ? new Date(r.date).getTime() : 0);
                return saleDate >= startStr && saleDate <= endStr;
            });

            renderList();
        };

        function renderList() {
            const listEl = document.getElementById('historyList');
            listEl.innerHTML = '';

            let totalSales = 0;
            let totalDue = 0;

            if (filteredRecords.length === 0) {
                listEl.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-light); font-weight: 600;"><i class="fas fa-box-open" style="font-size: 40px; color: #cbd5e1; margin-bottom: 10px;"></i><br>No sales records found for this date.</div>`;
            } else {
                filteredRecords.forEach(r => {
                    totalSales += Number(r.total_amount || 0);
                    totalDue += Number(r.due_amount || 0);

                    const hasDue = Number(r.due_amount) > 0;
                    const d = new Date(r.created_at || r.date);
                    
                    const html = `
                    <div class="history-card ${hasDue ? 'has-due' : ''}">
                        <div class="hc-header">
                            <div>
                                <div class="hc-supp">${r.customer_name || r.customer || 'Walk-in Customer'}</div>
                                <div class="hc-inv">INV: ${r.invoice_no || 'N/A'}</div>
                            </div>
                            <div class="hc-date">${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="hc-body">
                            <div class="hc-items"><i class="fas fa-box" style="color: #cbd5e1;"></i> ${r.items ? r.items.length : 0} Items</div>
                            <div class="hc-amt-box">
                                <div class="hc-total">৳${Number(r.total_amount).toLocaleString()}</div>
                                <div class="hc-paid">Received: ৳${Number(r.paid_amount || 0).toLocaleString()}</div>
                                ${hasDue ? `<div class="hc-due">Due: ৳${Number(r.due_amount).toLocaleString()}</div>` : ''}
                            </div>
                        </div>
                        <button onclick="viewReceipt('${r.id}')" class="btn-view">View Details</button>
                    </div>`;
                    listEl.insertAdjacentHTML('beforeend', html);
                });
            }

            document.getElementById('sumTotal').innerText = `৳${totalSales.toLocaleString()}`;
            document.getElementById('sumDue').innerText = `৳${totalDue.toLocaleString()}`;
        }

        window.viewReceipt = (id) => {
            const r = filteredRecords.find(x => x.id === id);
            if(!r) return;

            const content = document.getElementById('receiptContent');
            let itemsHtml = '';
            
            if(r.items && r.items.length > 0) {
                r.items.forEach(i => {
                    itemsHtml += `
                        <tr>
                            <td>${i.name}<br><span style="color:#9ca3af; font-size:10px;">@৳${i.rate || i.sellRate}</span></td>
                            <td class="text-center">${i.qty}</td>
                            <td class="text-right font-bold">৳${i.total || (i.qty * (i.rate || i.sellRate))}</td>
                        </tr>
                    `;
                });
            }

            const rDate = new Date(r.created_at || r.date).toLocaleString('en-GB', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #e5e7eb; padding-bottom: 10px;">
                    <div><span style="color:var(--text-light); font-size:10px; text-transform:uppercase;">Customer:</span><br><strong style="font-size:14px;">${r.customer_name || r.customer || 'Walk-in'}</strong></div>
                    <div class="text-right"><span style="color:var(--text-light); font-size:10px; text-transform:uppercase;">Date:</span><br><strong>${rDate}</strong></div>
                </div>
                
                <table>
                    <thead><tr><th>Item</th><th class="text-center">Qty</th><th class="text-right">Total</th></tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                
                <div style="border-top: 2px solid #e5e7eb; padding-top: 10px; font-size: 13px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:var(--text-light)"><span>Subtotal:</span><span>৳${r.sub_total || r.subtotal || r.total_amount}</span></div>
                    ${r.discount > 0 ? `<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:var(--danger)"><span>Discount:</span><span>-৳${r.discount}</span></div>` : ''}
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:800; font-size: 15px; color: var(--primary);"><span>Grand Total:</span><span>৳${r.total_amount}</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:var(--success); font-weight: 600;"><span>Received:</span><span>৳${r.paid_amount || 0}</span></div>
                    ${r.due_amount > 0 ? `<div style="display:flex; justify-content:space-between; font-weight:700; color:var(--danger);"><span>Due:</span><span>৳${r.due_amount}</span></div>` : ''}
                </div>
                <div style="margin-top: 15px; font-size: 11px; color: var(--text-light); text-align: center; background: #f8fafc; padding: 5px; border-radius: 8px;">Payment Method: <strong style="color: var(--text-dark);">${r.payment_method || 'Cash'}</strong></div>
            `;

            document.getElementById('receiptModal').style.display = 'flex';
        };

        // --- PDF EXPORT (PREVIEW BEFORE DOWNLOAD) ---
        window.downloadPDF = () => {
            if(filteredRecords.length === 0) {
                alert("No records to generate PDF!");
                return;
            }

            const btn = document.querySelector('.btn-pdf');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            // 1. Build Table Rows with Item Details
            let rowsHtml = '';
            let sumT = 0, sumP = 0, sumD = 0;

            filteredRecords.forEach(r => {
                sumT += Number(r.total_amount || 0);
                sumP += Number(r.paid_amount || 0);
                sumD += Number(r.due_amount || 0);
                
                const dDate = new Date(r.created_at || r.date).toLocaleDateString('en-GB');
                
                let itemsStr = "";
                if(r.items && r.items.length > 0) {
                    r.items.forEach(i => {
                        itemsStr += `• ${i.name} (${i.qty} ${i.unit || 'pcs'} @ ৳${i.rate || i.sellRate})<br>`;
                    });
                } else {
                    itemsStr = "No item details";
                }

                rowsHtml += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; vertical-align: top;">
                            <strong>${dDate}</strong><br>
                            <span style="color:#6b7280">${r.customer_name || r.customer || 'Walk-in'}</span><br>
                            <span style="font-size:10px; color:#9ca3af;">INV: ${r.invoice_no || 'N/A'}</span>
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; vertical-align: top; line-height:1.5;">
                            ${itemsStr}
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align:right; vertical-align: top; font-weight:bold;">
                            ${r.total_amount}
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align:right; vertical-align: top;">
                            <span style="color:green;">Recv: ${r.paid_amount || 0}</span><br>
                            ${r.due_amount > 0 ? `<span style="color:red; font-weight:bold;">Due: ${r.due_amount}</span>` : ''}
                        </td>
                    </tr>
                `;
            });

            // 2. Default Template
            const defaultTemplate = `
                <div style="font-family: 'Hind Siliguri', sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        {{SHOP_LOGO_IMG}}
                        <h2 style="font-size: 24px; margin-bottom: 5px; color: #1f2937;">{{SHOP_NAME}}</h2>
                        <p style="font-size: 14px; color: #6b7280; margin: 0;">Detailed Sales Report</p>
                        <p style="font-size: 12px; font-weight: bold; margin-top: 5px;">Date: {{DATE_RANGE}}</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 12px;">
                        <thead style="background-color: #10b981; color: white;">
                            <tr>
                                <th style="padding: 10px; border: 1px solid #ddd;">Date & Customer</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Items Sold (Qty x Rate)</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align:right;">Total (৳)</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align:right;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{TABLE_ROWS}}
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f3f4f6; font-size: 14px;">
                                <td colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight:bold;">Grand Total:</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align:right; font-weight:bold; color:#10b981;">৳ {{GRAND_TOTAL}}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align:right; font-weight:bold; color:red;">Due: ৳ {{TOTAL_DUE}}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            let finalTemplate = globalPdfTemplateCode ? globalPdfTemplateCode : defaultTemplate;
            
            let logoHtml = "";
            if(shopLogoImgUrl) {
                logoHtml = `<img src="${shopLogoImgUrl}" style="width:70px; height:70px; object-fit:cover; border-radius:50%; margin-bottom:10px;">`;
            }
            
            finalTemplate = finalTemplate.replace(/{{SHOP_NAME}}/g, SHOP_NAME);
            finalTemplate = finalTemplate.replace(/{{SHOP_LOGO_IMG}}/g, logoHtml);
            finalTemplate = finalTemplate.replace(/{{DATE_RANGE}}/g, `${dateFrom} to ${dateTo}`);
            finalTemplate = finalTemplate.replace(/{{TABLE_ROWS}}/g, rowsHtml);
            finalTemplate = finalTemplate.replace(/{{GRAND_TOTAL}}/g, sumT.toLocaleString());
            finalTemplate = finalTemplate.replace(/{{TOTAL_PAID}}/g, sumP.toLocaleString());
            finalTemplate = finalTemplate.replace(/{{TOTAL_DUE}}/g, sumD.toLocaleString());

            // 3. Generate Preview (Output to BlobURL)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = finalTemplate;
            
            html2pdf().set({
                margin: 10, 
                filename: `Sales_Report_${dateFrom}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(tempDiv).outputPdf('bloburl').then(function(pdfUrl) {
                window.open(pdfUrl, '_blank'); // Opens preview in new tab
                btn.innerHTML = originalText;
            });
        };
    </script>
</body>
</html>
